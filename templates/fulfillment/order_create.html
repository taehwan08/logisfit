{% extends 'base.html' %}
{% load static %}

{% block title %}주문 등록{% endblock %}
{% block page_title %}주문 등록{% endblock %}

{% block extra_css %}
<style>
    /* 선택바 */
    .selector-bar {
        background: #fff;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .selector-bar .form-select,
    .selector-bar .form-control {
        font-size: 0.85rem;
        border-radius: 6px;
    }
    .selector-bar label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 4px;
    }

    /* 테이블 카드 */
    .table-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .table-card.disabled-state {
        opacity: 0.55;
        pointer-events: none;
        user-select: none;
    }

    /* 액션 툴바 */
    .action-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 20px;
        background: #fff;
        border-bottom: 1px solid #eee;
    }
    .action-toolbar .btn { font-size: 0.82rem; }

    /* 컬럼 뱃지 */
    .column-badge {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        background: #e8f4fd;
        color: #2980b9;
    }

    /* 입력 테이블 */
    .create-table {
        margin-bottom: 0;
        font-size: 0.78rem;
        min-width: 100%;
    }
    .create-table thead th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
        padding: 8px 4px;
        position: sticky;
        top: 0;
        z-index: 1;
        font-size: 0.72rem;
        text-align: center;
    }
    .create-table thead th.required::after {
        content: ' *';
        color: #dc3545;
    }
    .create-table tbody td {
        padding: 3px 2px;
        vertical-align: middle;
    }
    .create-table tbody tr:hover { background-color: #f8f9ff; }
    .create-table .form-control {
        font-size: 0.78rem;
        padding: 3px 6px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        min-width: 70px;
    }
    .create-table .form-control:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52,152,219,0.15);
    }
    .create-table .form-control.is-invalid {
        border-color: #dc3545;
    }
    .create-table .row-num {
        text-align: center;
        color: #adb5bd;
        font-size: 0.72rem;
        width: 30px;
    }

    /* 반응형 테이블 */
    .table-responsive { max-height: calc(100vh - 300px); overflow: auto; }

    /* 토스트 */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }

    /* 붙여넣기 모달 */
    .paste-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        min-height: 200px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        white-space: pre;
        overflow: auto;
        transition: border-color 0.3s;
    }
    .paste-area:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
    }

    /* 체크박스 */
    .create-table .form-check-input { cursor: pointer; }

    /* 플랫폼 미선택 안내 */
    .platform-required-guide {
        text-align: center;
        padding: 60px 20px;
        color: #adb5bd;
    }
    .platform-required-guide i {
        font-size: 3rem;
        margin-bottom: 12px;
        display: block;
    }
    .platform-required-guide .guide-title {
        font-size: 1rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 6px;
    }
    .platform-required-guide .guide-desc {
        font-size: 0.82rem;
        color: #adb5bd;
    }
</style>
{% endblock %}

{% block content %}
<!-- 토스트 컨테이너 -->
<div class="toast-container" id="toastContainer"></div>

<!-- 선택바 -->
<div class="selector-bar">
    <div class="row g-2 align-items-end">
        <div class="col-md-3 col-6">
            <label>거래처 <span class="text-danger">*</span></label>
            <select class="form-select" id="createClient" onchange="onClientChange()" {% if is_client %}disabled{% endif %}>
                <option value="">선택</option>
                {% for c in clients %}
                <option value="{{ c.id }}">{{ c.company_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3 col-6">
            <label>브랜드</label>
            <select class="form-select" id="createBrand">
                <option value="">선택 (선택사항)</option>
            </select>
        </div>
        <div class="col-md-3 col-6">
            <label>플랫폼 <span class="text-danger">*</span></label>
            <select class="form-select" id="createPlatform" onchange="onPlatformChange()">
                <option value="">선택</option>
                {% for value, label in platforms %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3 col-6 d-flex align-items-end gap-2">
            <a href="{% url 'fulfillment:order_list' %}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left me-1"></i>목록
            </a>
        </div>
    </div>
</div>

<!-- 플랫폼 미선택 시 안내 -->
<div id="platformRequiredGuide">
    <div class="table-card">
        <div class="platform-required-guide">
            <i class="bi bi-arrow-up-circle"></i>
            <p class="guide-title">플랫폼을 먼저 선택해주세요</p>
            <p class="guide-desc">플랫폼에 따라 입력 컬럼이 자동으로 설정됩니다.</p>
        </div>
    </div>
</div>

<!-- 테이블 카드 (플랫폼 선택 후 표시) -->
<div class="table-card" id="tableCard" style="display:none;">
    <!-- 액션 툴바 -->
    <div class="action-toolbar">
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted" style="font-size:0.82rem;">
                등록할 주문: <strong id="rowCount">0</strong>건
            </span>
            <span class="column-badge" id="columnInfo" style="display:none;">
                <i class="bi bi-layout-three-columns"></i>
                <span id="columnInfoText"></span>
            </span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnPaste" onclick="showPasteModal()">
                <i class="bi bi-clipboard me-1"></i>붙여넣기
            </button>
            <button class="btn btn-outline-danger btn-sm" id="btnDelete" onclick="deleteSelectedRows()">
                <i class="bi bi-trash me-1"></i>선택 삭제
            </button>
            <button class="btn btn-outline-primary btn-sm" id="btnAddRow" onclick="addRow()">
                <i class="bi bi-plus-lg me-1"></i>행 추가
            </button>
            <button class="btn btn-primary btn-sm" id="btnSubmit" onclick="submitOrders()">
                <i class="bi bi-check-lg me-1"></i>일괄 등록
            </button>
        </div>
    </div>

    <!-- 테이블 -->
    <div class="table-responsive">
        <table class="create-table table table-bordered" id="createTable">
            <thead>
                <tr id="tableHead">
                    <!-- JS로 동적 구성 -->
                </tr>
            </thead>
            <tbody id="createBody">
                <!-- JS로 행 렌더링 -->
            </tbody>
        </table>
    </div>

    <!-- 빈 상태 -->
    <div class="text-center py-5 text-muted" id="emptyGuide">
        <i class="bi bi-plus-square" style="font-size:2.5rem;"></i>
        <p class="mt-2 mb-0">위의 <strong>행 추가</strong> 버튼을 클릭하거나, <strong>붙여넣기</strong>로 데이터를 추가하세요.</p>
    </div>
</div>

<!-- 붙여넣기 모달 -->
<div class="modal fade" id="pasteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background:#2c3e50;color:#fff;">
                <h5 class="modal-title"><i class="bi bi-clipboard me-2"></i>붙여넣기 도우미</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info py-2 mb-3" style="font-size:0.82rem;">
                    <i class="bi bi-info-circle me-1"></i>
                    플랫폼에서 복사한 표를 아래에 <strong>Ctrl+V</strong>로 붙여넣기 하세요.<br>
                    <strong>컬럼 순서:</strong> <span id="pasteColumnGuide"></span>
                </div>
                <textarea class="form-control paste-area" id="pasteTextarea"
                          placeholder="여기에 표 내용을 붙여넣기 하세요...&#10;&#10;탭으로 구분된 데이터가 자동 인식됩니다."
                          rows="10"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" onclick="applyPaste()">
                    <i class="bi bi-check-lg me-1"></i>적용
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// 전역 변수
// ============================================================================
const IS_ADMIN = {{ is_admin|yesno:"true,false" }};
const IS_CLIENT = {{ is_client|yesno:"true,false" }};
const IS_WORKER = {{ is_worker|yesno:"true,false" }};
const CSRF_TOKEN = '{{ csrf_token }}';

let currentColumns = [];    // 현재 활성 컬럼 목록
let platformSelected = false;
let rowCounter = 0;

// ============================================================================
// 플랫폼별 기본 컬럼 프리셋
// PlatformColumnConfig DB에 설정이 없을 때 사용하는 기본값
// 관리자가 주문목록 > 컬럼 설정에서 커스터마이즈 가능
// ============================================================================
const PLATFORM_PRESETS = {
    // 쿠팡: 발주번호, 발주유형, 발주확정, SKU ID, 상품명, 바코드, 센터, 입고일, 발주일시, 발주수량, 확정수량
    coupang: [
        { key: 'order_number',       name: '발주번호',   required: true,  type: 'text',   width: '120px' },
        { key: 'order_type',         name: '발주유형',   required: false, type: 'text',   width: '90px' },
        { key: 'order_confirmed',    name: '발주확정',   required: false, type: 'text',   width: '90px' },
        { key: 'sku_id',             name: 'SKU ID',     required: false, type: 'text',   width: '100px' },
        { key: 'product_name',       name: '상품명',     required: true,  type: 'text',   width: '200px' },
        { key: 'barcode',            name: '바코드',     required: false, type: 'text',   width: '120px' },
        { key: 'center',             name: '센터',       required: false, type: 'text',   width: '100px' },
        { key: 'receiving_date',     name: '입고일',     required: false, type: 'text',   width: '100px' },
        { key: 'order_date',         name: '발주일시',   required: false, type: 'text',   width: '120px' },
        { key: 'order_quantity',     name: '발주수량',   required: false, type: 'number', width: '80px' },
        { key: 'confirmed_quantity', name: '확정수량',   required: false, type: 'number', width: '80px' },
    ],
    // 컬리
    kurly: [
        { key: 'order_number',       name: '발주번호',   required: true,  type: 'text',   width: '120px' },
        { key: 'product_name',       name: '상품명',     required: true,  type: 'text',   width: '200px' },
        { key: 'barcode',            name: '바코드',     required: false, type: 'text',   width: '120px' },
        { key: 'order_quantity',     name: '발주수량',   required: false, type: 'number', width: '80px' },
        { key: 'confirmed_quantity', name: '확정수량',   required: false, type: 'number', width: '80px' },
    ],
    // 올리브영
    oliveyoung: [
        { key: 'order_number',       name: '발주번호',   required: true,  type: 'text',   width: '120px' },
        { key: 'product_name',       name: '상품명',     required: true,  type: 'text',   width: '200px' },
        { key: 'barcode',            name: '바코드',     required: false, type: 'text',   width: '120px' },
        { key: 'order_quantity',     name: '발주수량',   required: false, type: 'number', width: '80px' },
        { key: 'confirmed_quantity', name: '확정수량',   required: false, type: 'number', width: '80px' },
    ],
    // 스마트스토어
    smartstore: [
        { key: 'order_number',       name: '발주번호',   required: true,  type: 'text',   width: '120px' },
        { key: 'product_name',       name: '상품명',     required: true,  type: 'text',   width: '200px' },
        { key: 'barcode',            name: '바코드',     required: false, type: 'text',   width: '120px' },
        { key: 'order_quantity',     name: '발주수량',   required: false, type: 'number', width: '80px' },
        { key: 'confirmed_quantity', name: '확정수량',   required: false, type: 'number', width: '80px' },
    ],
    // 오프라인마트
    offline: [
        { key: 'order_number',       name: '발주번호',   required: true,  type: 'text',   width: '120px' },
        { key: 'product_name',       name: '상품명',     required: true,  type: 'text',   width: '200px' },
        { key: 'barcode',            name: '바코드',     required: false, type: 'text',   width: '120px' },
        { key: 'order_quantity',     name: '발주수량',   required: false, type: 'number', width: '80px' },
        { key: 'confirmed_quantity', name: '확정수량',   required: false, type: 'number', width: '80px' },
    ],
    // 해외수출
    export: [
        { key: 'order_number',       name: '발주번호',   required: true,  type: 'text',   width: '120px' },
        { key: 'product_name',       name: '상품명',     required: true,  type: 'text',   width: '200px' },
        { key: 'barcode',            name: '바코드',     required: false, type: 'text',   width: '120px' },
        { key: 'order_quantity',     name: '발주수량',   required: false, type: 'number', width: '80px' },
        { key: 'confirmed_quantity', name: '확정수량',   required: false, type: 'number', width: '80px' },
    ],
    // 기타
    other: [
        { key: 'order_number',       name: '발주번호',   required: true,  type: 'text',   width: '120px' },
        { key: 'product_name',       name: '상품명',     required: true,  type: 'text',   width: '200px' },
        { key: 'barcode',            name: '바코드',     required: false, type: 'text',   width: '120px' },
        { key: 'order_quantity',     name: '발주수량',   required: false, type: 'number', width: '80px' },
        { key: 'confirmed_quantity', name: '확정수량',   required: false, type: 'number', width: '80px' },
    ],
};

// 공통 모델 필드 키 (platform_data에 저장하지 않는 필드)
const MODEL_FIELDS = [
    'order_number', 'product_name', 'barcode', 'order_quantity', 'confirmed_quantity',
    'order_type', 'order_confirmed', 'sku_id', 'center', 'receiving_date', 'order_date',
    'manager', 'expiry_date', 'box_quantity', 'address', 'memo',
];

// ============================================================================
// 초기화
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    if (IS_CLIENT) {
        const sel = document.getElementById('createClient');
        if (sel && sel.options.length > 1) {
            sel.value = sel.options[1].value;
            onClientChange();
        }
    }
});

// ============================================================================
// 거래처/브랜드/플랫폼 변경
// ============================================================================
function onClientChange() {
    const clientId = document.getElementById('createClient').value;
    const brandSel = document.getElementById('createBrand');
    brandSel.innerHTML = '<option value="">선택 (선택사항)</option>';
    if (!clientId) return;

    fetch(`{% url 'fulfillment:get_brands' %}?client_id=${clientId}`)
        .then(r => r.json())
        .then(data => {
            (data.brands || []).forEach(b => {
                brandSel.insertAdjacentHTML('beforeend',
                    `<option value="${b.id}">${escapeHtml(b.name)}</option>`);
            });
        });
}

function onPlatformChange() {
    const platform = document.getElementById('createPlatform').value;

    if (!platform) {
        // 플랫폼 해제 → 테이블 숨기고 안내 표시
        platformSelected = false;
        currentColumns = [];
        document.getElementById('platformRequiredGuide').style.display = '';
        document.getElementById('tableCard').style.display = 'none';
        return;
    }

    // API에서 PlatformColumnConfig 조회 시도
    fetch(`{% url 'fulfillment:get_platform_columns' %}?platform=${platform}`)
        .then(r => r.json())
        .then(data => {
            const apiColumns = data.columns || [];

            if (apiColumns.length > 0) {
                // DB에 설정된 컬럼이 있으면 그것을 사용
                currentColumns = apiColumns.map(pc => ({
                    key: MODEL_FIELDS.includes(pc.key) ? pc.key : 'pd_' + pc.key,
                    name: pc.name,
                    required: pc.is_required,
                    type: pc.column_type,
                    width: '100px',
                    isPlatformCol: !MODEL_FIELDS.includes(pc.key),
                    platformKey: pc.key,
                }));
            } else {
                // DB에 없으면 프리셋 사용
                currentColumns = [...(PLATFORM_PRESETS[platform] || PLATFORM_PRESETS.other)];
            }

            // 테이블 활성화
            platformSelected = true;
            document.getElementById('platformRequiredGuide').style.display = 'none';
            document.getElementById('tableCard').style.display = '';

            rebuildTable();
            updateColumnInfo();
        });
}

function updateColumnInfo() {
    const badge = document.getElementById('columnInfo');
    const text = document.getElementById('columnInfoText');
    const platform = document.getElementById('createPlatform');

    if (platform.value) {
        const platformLabel = platform.options[platform.selectedIndex].text;
        text.textContent = `${platformLabel} ${currentColumns.length}개 컬럼`;
        badge.style.display = '';
    } else {
        badge.style.display = 'none';
    }

    // 붙여넣기 가이드 업데이트
    const guide = document.getElementById('pasteColumnGuide');
    if (currentColumns.length > 0) {
        guide.textContent = currentColumns.map(c => c.name).join(' | ');
    }
}

// ============================================================================
// 테이블 구성
// ============================================================================
function rebuildTable() {
    const cols = currentColumns;
    const thead = document.getElementById('tableHead');

    // 헤더 재구성
    let headerHtml = `
        <th style="width:36px;">
            <input class="form-check-input" type="checkbox" id="checkAllCreate" onchange="toggleCheckAllCreate(this)">
        </th>
        <th style="width:30px;">#</th>`;

    cols.forEach(col => {
        headerHtml += `<th class="${col.required ? 'required' : ''}" style="min-width:${col.width}">${escapeHtml(col.name)}</th>`;
    });

    headerHtml += `
        <th>비고</th>
        <th style="width:36px;"></th>`;

    thead.innerHTML = headerHtml;

    // 기존 행 데이터 수집
    const existingRows = collectAllRowData();

    // 기존 행 다시 렌더링
    const tbody = document.getElementById('createBody');
    tbody.innerHTML = '';
    rowCounter = 0;

    existingRows.forEach(rowData => {
        addRow(rowData);
    });

    updateRowCount();
}

function addRow(prefillData) {
    if (!platformSelected) {
        showToast('플랫폼을 먼저 선택해주세요.', 'warning');
        return;
    }

    rowCounter++;
    const cols = currentColumns;
    const tbody = document.getElementById('createBody');
    const rowId = rowCounter;

    let html = `<tr data-row-id="${rowId}">
        <td class="text-center">
            <input class="form-check-input row-check-create" type="checkbox" value="${rowId}">
        </td>
        <td class="row-num">${rowId}</td>`;

    cols.forEach(col => {
        let val = '';
        if (prefillData) {
            val = prefillData[col.key] || '';
            if (!val && col.platformKey) {
                val = prefillData[col.platformKey] || '';
            }
        }
        const inputType = col.type === 'number' ? 'number' : 'text';
        html += `<td>
            <input class="form-control" type="${inputType}" data-key="${col.key}"
                   value="${escapeHtml(String(val))}"
                   ${col.required ? 'required' : ''}
                   style="min-width:${col.width}">
        </td>`;
    });

    const memo = prefillData ? (prefillData.memo || '') : '';
    html += `<td>
            <input class="form-control" type="text" data-key="memo"
                   value="${escapeHtml(String(memo))}" style="min-width:80px">
        </td>
        <td class="text-center">
            <button class="btn btn-sm btn-outline-danger p-0" style="width:24px;height:24px;font-size:0.7rem;"
                    onclick="removeRow(this)" title="삭제">
                <i class="bi bi-x"></i>
            </button>
        </td>
    </tr>`;

    tbody.insertAdjacentHTML('beforeend', html);
    updateRowCount();

    // 마지막 행의 첫 입력에 포커스
    if (!prefillData) {
        const lastRow = tbody.lastElementChild;
        const firstInput = lastRow.querySelector('input[type="text"], input[type="number"]');
        if (firstInput) firstInput.focus();
    }
}

function removeRow(btn) {
    btn.closest('tr').remove();
    renumberRows();
    updateRowCount();
}

function renumberRows() {
    const rows = document.querySelectorAll('#createBody tr');
    rows.forEach((row, idx) => {
        const numCell = row.querySelector('.row-num');
        if (numCell) numCell.textContent = idx + 1;
    });
}

function updateRowCount() {
    const count = document.querySelectorAll('#createBody tr').length;
    document.getElementById('rowCount').textContent = count;
    document.getElementById('emptyGuide').style.display = count > 0 ? 'none' : '';
}

// ============================================================================
// 체크박스
// ============================================================================
function toggleCheckAllCreate(el) {
    document.querySelectorAll('.row-check-create').forEach(c => c.checked = el.checked);
}

function deleteSelectedRows() {
    const checked = document.querySelectorAll('.row-check-create:checked');
    if (checked.length === 0) { showToast('선택된 행이 없습니다.', 'warning'); return; }
    if (!confirm(`선택된 ${checked.length}건을 삭제하시겠습니까?`)) return;
    checked.forEach(c => c.closest('tr').remove());
    const checkAll = document.getElementById('checkAllCreate');
    if (checkAll) { checkAll.checked = false; checkAll.indeterminate = false; }
    renumberRows();
    updateRowCount();
}

// ============================================================================
// 데이터 수집 & 제출
// ============================================================================
function collectAllRowData() {
    const rows = document.querySelectorAll('#createBody tr');
    const result = [];
    rows.forEach(row => {
        const data = {};
        row.querySelectorAll('input[data-key]').forEach(input => {
            data[input.dataset.key] = input.value;
        });
        result.push(data);
    });
    return result;
}

function submitOrders() {
    const clientId = document.getElementById('createClient').value;
    const brandId = document.getElementById('createBrand').value;
    const platform = document.getElementById('createPlatform').value;

    if (!clientId) { showToast('거래처를 선택해주세요.', 'warning'); return; }
    if (!platform) { showToast('플랫폼을 선택해주세요.', 'warning'); return; }

    const rowsData = collectAllRowData();
    if (rowsData.length === 0) { showToast('등록할 주문이 없습니다.', 'warning'); return; }

    // 필수값 검증
    let hasError = false;
    const requiredKeys = currentColumns.filter(c => c.required).map(c => c.key);

    document.querySelectorAll('#createBody tr').forEach((row, idx) => {
        requiredKeys.forEach(key => {
            const input = row.querySelector(`input[data-key="${key}"]`);
            if (input && !input.value.trim()) {
                input.classList.add('is-invalid');
                hasError = true;
            } else if (input) {
                input.classList.remove('is-invalid');
            }
        });
    });

    if (hasError) {
        const requiredNames = currentColumns.filter(c => c.required).map(c => c.name).join(', ');
        showToast(`${requiredNames}은(는) 필수입니다.`, 'warning');
        return;
    }

    // 주문 데이터 조립
    const orders = rowsData.map(data => {
        const order = {};
        const pd = {};

        Object.keys(data).forEach(k => {
            if (k === 'memo') {
                order.memo = data[k] || '';
            } else if (k.startsWith('pd_')) {
                const realKey = k.substring(3);
                if (data[k]) pd[realKey] = data[k];
            } else if (MODEL_FIELDS.includes(k)) {
                order[k] = data[k] || '';
            }
        });

        order.platform_data = pd;
        return order;
    });

    // 전송
    const submitBtn = document.getElementById('btnSubmit');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>등록 중...';

    fetch('{% url "fulfillment:bulk_create_orders" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({
            client_id: parseInt(clientId),
            brand_id: brandId ? parseInt(brandId) : null,
            platform: platform,
            orders: orders,
        }),
    })
    .then(r => r.json())
    .then(data => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>일괄 등록';

        if (data.success) {
            let msg = data.message;
            if (data.error_count) msg += ` (오류 ${data.error_count}건)`;
            showToast(msg, data.error_count ? 'warning' : 'success');

            if (data.errors && data.errors.length > 0) {
                alert('오류 목록:\n' + data.errors.join('\n'));
            }

            if (!data.error_count || data.created_count > 0) {
                setTimeout(() => {
                    window.location.href = '{% url "fulfillment:order_list" %}';
                }, 1000);
            }
        } else {
            showToast(data.error || '등록 실패', 'danger');
        }
    })
    .catch(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>일괄 등록';
        showToast('서버 오류', 'danger');
    });
}

// ============================================================================
// 붙여넣기
// ============================================================================
function showPasteModal() {
    if (!platformSelected) {
        showToast('플랫폼을 먼저 선택해주세요.', 'warning');
        return;
    }
    document.getElementById('pasteTextarea').value = '';
    updateColumnInfo();
    new bootstrap.Modal(document.getElementById('pasteModal')).show();
}

function applyPaste() {
    const text = document.getElementById('pasteTextarea').value.trim();
    if (!text) { showToast('붙여넣기할 데이터가 없습니다.', 'warning'); return; }

    const lines = text.split('\n').filter(l => l.trim());
    let addedCount = 0;

    lines.forEach(line => {
        const cols = line.split('\t');
        if (!cols[0]?.trim()) return;

        // 현재 컬럼 순서에 맞춰 매핑
        const data = {};
        currentColumns.forEach((colDef, idx) => {
            if (idx < cols.length) {
                data[colDef.key] = (cols[idx] || '').trim();
            }
        });

        addRow(data);
        addedCount++;
    });

    bootstrap.Modal.getInstance(document.getElementById('pasteModal')).hide();
    showToast(`${addedCount}건이 추가되었습니다.`, 'success');
}

// ============================================================================
// 유틸리티
// ============================================================================
function showToast(message, type) {
    const container = document.getElementById('toastContainer');
    const id = 'toast_' + Date.now();
    const icons = { success: 'bi-check-circle-fill', danger: 'bi-exclamation-triangle-fill', warning: 'bi-exclamation-circle-fill', info: 'bi-info-circle-fill' };
    const html = `<div id="${id}" class="toast align-items-center text-bg-${type} border-0 show" role="alert">
        <div class="d-flex"><div class="toast-body"><i class="bi ${icons[type] || icons.info} me-1"></i>${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
    container.insertAdjacentHTML('beforeend', html);
    setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, 3000);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
