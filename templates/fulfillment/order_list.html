{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}출고 현황{% endblock %}
{% block page_title %}출고 현황{% endblock %}

{% block extra_css %}
<style>
    /* 필터바 */
    .filter-bar {
        background: #fff;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    }
    .filter-bar .form-select,
    .filter-bar .form-control {
        font-size: 0.85rem;
        border-radius: 6px;
    }
    .filter-bar label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #6c757d;
        margin-bottom: 4px;
    }

    /* 테이블 카드 */
    .table-card {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    .table-card .table {
        margin-bottom: 0;
        font-size: 0.78rem;
    }
    .table-card .table thead th {
        background: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
        padding: 8px 8px;
        position: sticky;
        top: 0;
        z-index: 1;
        font-size: 0.72rem;
    }
    .table-card .table tbody td {
        padding: 6px 8px;
        vertical-align: middle;
        border-bottom: 1px solid #f0f0f0;
        white-space: nowrap;
    }
    .table-card .table tbody tr:hover {
        background-color: #f8f9ff;
    }

    /* 상태 체크 아이콘 */
    .status-check {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 0.65rem;
        cursor: default;
        transition: all 0.2s;
    }
    .status-check.clickable { cursor: pointer; }
    .status-check.clickable:hover { transform: scale(1.15); box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
    .status-check.pending { background: #e9ecef; color: #adb5bd; }
    .status-check.confirmed { background: #3498db; color: #fff; }
    .status-check.shipped { background: #f39c12; color: #fff; }
    .status-check.synced { background: #2ecc71; color: #fff; }
    .status-check.disabled { opacity: 0.4; cursor: not-allowed; }

    /* 플랫폼 배지 */
    .badge-platform {
        font-size: 0.68rem;
        padding: 2px 6px;
        border-radius: 8px;
        font-weight: 500;
    }
    .badge-platform.coupang { background: #e8f0fe; color: #1a73e8; }
    .badge-platform.kurly { background: #f3e8ff; color: #7c3aed; }
    .badge-platform.oliveyoung { background: #e8fdf0; color: #059669; }
    .badge-platform.smartstore { background: #fff8e1; color: #f59e0b; }
    .badge-platform.offline { background: #fce8e8; color: #dc2626; }
    .badge-platform.export { background: #e8f4f8; color: #0891b2; }
    .badge-platform.other { background: #f3f4f6; color: #6b7280; }

    /* 페이지네이션 */
    .pagination-info { font-size: 0.82rem; color: #6c757d; }
    .pagination .page-link { font-size: 0.82rem; padding: 6px 12px; border-radius: 6px; margin: 0 2px; }

    /* 액션 버튼 */
    .btn-action { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }

    /* 모달 */
    .modal-header { background: #2c3e50; color: #fff; }
    .modal-header .btn-close { filter: invert(1); }
    .modal .form-label { font-size: 0.8rem; font-weight: 600; color: #495057; }
    .modal .form-control, .modal .form-select { font-size: 0.85rem; }

    /* 댓글 영역 */
    .comment-section { border-top: 1px solid #eee; margin-top: 16px; padding-top: 16px; }
    .comment-section h6 { font-size: 0.85rem; font-weight: 700; color: #495057; margin-bottom: 12px; }
    .comment-list { max-height: 300px; overflow-y: auto; padding-right: 4px; }
    .comment-item { display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f5f5f5; }
    .comment-item:last-child { border-bottom: none; }
    .comment-avatar { flex-shrink: 0; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; color: #fff; }
    .comment-avatar.admin { background: #3498db; }
    .comment-avatar.client { background: #2ecc71; }
    .comment-avatar.worker { background: #f39c12; }
    .comment-avatar.system { background: #95a5a6; }
    .comment-body { flex: 1; min-width: 0; }
    .comment-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
    .comment-author { font-size: 0.78rem; font-weight: 600; color: #333; }
    .comment-role { font-size: 0.65rem; padding: 1px 5px; border-radius: 8px; background: #e9ecef; color: #6c757d; }
    .comment-time { font-size: 0.7rem; color: #adb5bd; margin-left: auto; }
    .comment-content { font-size: 0.82rem; color: #333; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .comment-item.system-msg { padding: 6px 0; }
    .comment-item.system-msg .comment-content { font-size: 0.75rem; color: #6c757d; font-style: italic; }
    .comment-input-area { display: flex; gap: 8px; margin-top: 12px; }
    .comment-input-area textarea { flex: 1; font-size: 0.82rem; border-radius: 8px; resize: none; min-height: 38px; max-height: 80px; padding: 8px 12px; }
    .comment-input-area .btn { flex-shrink: 0; align-self: flex-end; }
    .comment-delete-btn { opacity: 0; transition: opacity 0.2s; border: none; background: none; color: #adb5bd; font-size: 0.7rem; padding: 0 4px; cursor: pointer; }
    .comment-item:hover .comment-delete-btn { opacity: 1; }
    .comment-delete-btn:hover { color: #e74c3c; }
    .comment-empty { text-align: center; padding: 20px; color: #adb5bd; font-size: 0.82rem; }

    /* 액션 툴바 */
    .action-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: #fff; border-bottom: 1px solid #eee; }
    .action-toolbar .btn { font-size: 0.82rem; }

    /* 빈 상태 */
    .empty-state { padding: 60px 20px; text-align: center; color: #adb5bd; }
    .empty-state i { font-size: 3rem; margin-bottom: 12px; }

    /* 로딩 */
    .loading-overlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); z-index: 10; align-items: center; justify-content: center; }
    .loading-overlay.show { display: flex; }

    /* 반응형 테이블 - 가로 스크롤 */
    .table-responsive { max-height: calc(100vh - 320px); overflow: auto; }

    /* 토스트 */
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }

    /* 붙여넣기 영역 */
    .paste-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        min-height: 200px;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        white-space: pre;
        overflow: auto;
        transition: border-color 0.3s;
    }
    .paste-area:focus {
        border-color: #3498db;
        outline: none;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
    }
    .paste-preview-table {
        font-size: 0.72rem;
        border-collapse: collapse;
        width: 100%;
    }
    .paste-preview-table th {
        background: #f1f3f5;
        padding: 4px 6px;
        font-weight: 600;
        white-space: nowrap;
        border: 1px solid #dee2e6;
    }
    .paste-preview-table td {
        padding: 3px 6px;
        white-space: nowrap;
        border: 1px solid #eee;
    }
    .paste-preview-wrapper {
        max-height: 300px;
        overflow: auto;
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }

    /* 브랜드 관리 */
    .brand-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 10px;
        border-bottom: 1px solid #f5f5f5;
        font-size: 0.85rem;
    }
    .brand-item:last-child { border-bottom: none; }
</style>
{% endblock %}

{% block content %}
<!-- 토스트 컨테이너 -->
<div class="toast-container" id="toastContainer"></div>

<!-- 필터바 -->
<div class="filter-bar">
    <div class="row g-2 align-items-end">
        {% if not is_client %}
        <div class="col-md-2 col-6">
            <label>거래처</label>
            <select class="form-select" id="filterClient" onchange="onFilterClientChange()">
                <option value="">전체</option>
                {% for c in clients %}
                <option value="{{ c.id }}">{{ c.company_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 col-6">
            <label>브랜드</label>
            <select class="form-select" id="filterBrand" onchange="loadOrders()">
                <option value="">전체</option>
            </select>
        </div>
        {% endif %}
        <div class="col-md-2 col-6">
            <label>플랫폼</label>
            <select class="form-select" id="filterPlatform" onchange="loadOrders()">
                <option value="">전체</option>
                {% for value, label in platforms %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-1 col-6">
            <label>상태</label>
            <select class="form-select" id="filterStatus" onchange="loadOrders()">
                <option value="">전체</option>
                {% for value, label in statuses %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 col-6">
            <label>검색</label>
            <input type="text" class="form-control" id="filterSearch" placeholder="발주번호/상품명/바코드/SKU"
                   onkeyup="debounceSearch()">
        </div>
    </div>
</div>

<!-- 테이블 카드 -->
<div class="table-card position-relative">
    <!-- 액션 툴바 -->
    <div class="action-toolbar">
        <div>
            <span class="pagination-info" id="totalInfo">-</span>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-success btn-sm" onclick="exportExcel()">
                <i class="bi bi-file-earmark-excel me-1"></i>엑셀
            </button>
            {% if is_admin or is_worker %}
            <button class="btn btn-outline-info btn-sm" onclick="showBrandModal()">
                <i class="bi bi-tag me-1"></i>브랜드 관리
            </button>
            {% endif %}
            {% if is_admin or is_client %}
            <button class="btn btn-primary btn-sm" onclick="showPasteModal()">
                <i class="bi bi-clipboard-plus me-1"></i>주문 등록
            </button>
            {% endif %}
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- 테이블 -->
    <div class="table-responsive">
        <table class="table table-hover" id="ordersTable">
            <thead>
                <tr>
                    <th>발주번호</th>
                    <th>발주유형</th>
                    <th>발주확정</th>
                    <th>거래처</th>
                    <th>브랜드</th>
                    <th>플랫폼</th>
                    <th>SKU ID</th>
                    <th>상품명</th>
                    <th>바코드</th>
                    <th>센터</th>
                    <th>입고일</th>
                    <th>발주일시</th>
                    <th class="text-end">발주수량</th>
                    <th class="text-end">확정수량</th>
                    <th class="text-center" style="width:40px">확인</th>
                    <th class="text-center" style="width:40px">출고</th>
                    <th class="text-center" style="width:40px">전산</th>
                    {% if is_admin or is_worker %}
                    <th style="width:60px">작업</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody id="ordersBody">
                <!-- JS로 렌더링 -->
            </tbody>
        </table>
    </div>

    <!-- 빈 상태 -->
    <div class="empty-state d-none" id="emptyState">
        <i class="bi bi-inbox"></i>
        <p>등록된 주문이 없습니다.</p>
    </div>

    <!-- 페이지네이션 -->
    <div class="d-flex justify-content-between align-items-center px-3 py-2" id="paginationArea" style="display:none!important;">
        <span class="pagination-info" id="pageInfo"></span>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

<!-- ============================================================ -->
<!-- 붙여넣기 주문 등록 모달 -->
<!-- ============================================================ -->
<div class="modal fade" id="pasteModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-clipboard-plus me-2"></i>주문 등록 (붙여넣기)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 거래처 / 브랜드 / 플랫폼 선택 -->
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">거래처 <span class="text-danger">*</span></label>
                        <select class="form-select" id="pasteClient" onchange="onPasteClientChange()" {% if is_client %}disabled{% endif %}>
                            <option value="">선택</option>
                            {% for c in clients %}
                            <option value="{{ c.id }}">{{ c.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">브랜드</label>
                        <select class="form-select" id="pasteBrand">
                            <option value="">선택 (선택사항)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">플랫폼 <span class="text-danger">*</span></label>
                        <select class="form-select" id="pastePlatform">
                            <option value="">선택</option>
                            {% for value, label in platforms %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- 안내 -->
                <div class="alert alert-info py-2 mb-3" style="font-size:0.82rem;">
                    <i class="bi bi-info-circle me-1"></i>
                    플랫폼(쿠팡 등)에서 표를 복사한 뒤, 아래 영역에 <strong>Ctrl+V</strong>로 붙여넣기 하세요.<br>
                    <strong>컬럼 순서:</strong> 발주번호 | 발주유형 | 발주확정 | SKU ID | 상품명 | 바코드 | 센터 | 입고일 | 발주일시 | 발주수량 | 확정수량
                </div>

                <!-- 붙여넣기 영역 -->
                <textarea class="form-control paste-area" id="pasteTextarea"
                          placeholder="여기에 표 내용을 붙여넣기 하세요...&#10;&#10;탭으로 구분된 데이터가 자동 인식됩니다."
                          rows="8" oninput="onPasteInput()"></textarea>

                <!-- 미리보기 -->
                <div id="pastePreview" class="mt-3" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong style="font-size:0.85rem;"><i class="bi bi-eye me-1"></i>미리보기 (<span id="pasteRowCount">0</span>건)</strong>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearPaste()">
                            <i class="bi bi-x-lg me-1"></i>초기화
                        </button>
                    </div>
                    <div class="paste-preview-wrapper">
                        <table class="paste-preview-table" id="pastePreviewTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>발주번호</th>
                                    <th>발주유형</th>
                                    <th>발주확정</th>
                                    <th>SKU ID</th>
                                    <th>상품명</th>
                                    <th>바코드</th>
                                    <th>센터</th>
                                    <th>입고일</th>
                                    <th>발주일시</th>
                                    <th>발주수량</th>
                                    <th>확정수량</th>
                                </tr>
                            </thead>
                            <tbody id="pastePreviewBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="btnBulkPaste" onclick="submitBulkPaste()" disabled>
                    <i class="bi bi-check-lg me-1"></i>일괄 등록
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- 상세 보기 모달 -->
<!-- ============================================================ -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">주문 상세</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detailModalBody"></div>

                <!-- 댓글 영역 -->
                <div class="comment-section">
                    <h6><i class="bi bi-chat-dots me-1"></i>댓글 <span class="text-muted fw-normal" id="commentCount"></span></h6>
                    <div class="comment-list" id="commentList">
                        <div class="comment-empty">댓글을 불러오는 중...</div>
                    </div>
                    <div class="comment-input-area">
                        <textarea class="form-control" id="commentInput" placeholder="댓글을 입력하세요..."
                                  rows="1" onkeydown="handleCommentKeydown(event)"></textarea>
                        <button class="btn btn-primary btn-sm" onclick="addComment()">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- 브랜드 관리 모달 -->
<!-- ============================================================ -->
<div class="modal fade" id="brandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-tag me-2"></i>브랜드 관리</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">거래처 선택</label>
                    <select class="form-select" id="brandClient" onchange="loadBrandsForManage()">
                        <option value="">거래처를 선택하세요</option>
                        {% for c in clients %}
                        <option value="{{ c.id }}">{{ c.company_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 브랜드 목록 -->
                <div id="brandList" class="mb-3 border rounded" style="min-height:50px; max-height:250px; overflow-y:auto;">
                    <div class="text-center text-muted py-3" style="font-size:0.85rem;">거래처를 선택하세요</div>
                </div>

                <!-- 브랜드 추가 -->
                <div class="d-flex gap-2">
                    <input type="text" class="form-control form-control-sm" id="newBrandName" placeholder="새 브랜드명"
                           onkeydown="if(event.key==='Enter')addBrand()">
                    <button class="btn btn-sm btn-primary" onclick="addBrand()" style="white-space:nowrap;">
                        <i class="bi bi-plus-lg me-1"></i>추가
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ============================================================================
// 전역 변수
// ============================================================================
const IS_ADMIN = {{ is_admin|yesno:"true,false" }};
const IS_CLIENT = {{ is_client|yesno:"true,false" }};
const IS_WORKER = {{ is_worker|yesno:"true,false" }};
const CAN_MANAGE = IS_ADMIN || IS_WORKER;
const CSRF_TOKEN = '{{ csrf_token }}';
let currentPage = 1;
let searchTimer = null;
let ordersData = [];
let currentDetailOrderId = null;

// ============================================================================
// 초기화
// ============================================================================
document.addEventListener('DOMContentLoaded', function() {
    if (IS_CLIENT) {
        const sel = document.getElementById('pasteClient');
        if (sel && sel.options.length > 1) sel.value = sel.options[1].value;
    }
    loadOrders();
});

// ============================================================================
// 필터 - 거래처 변경 시 브랜드 로드
// ============================================================================
function onFilterClientChange() {
    loadFilterBrands();
    loadOrders();
}

function loadFilterBrands() {
    const clientId = document.getElementById('filterClient')?.value;
    const brandSel = document.getElementById('filterBrand');
    if (!brandSel) return;

    brandSel.innerHTML = '<option value="">전체</option>';
    if (!clientId) return;

    fetch(`{% url 'fulfillment:get_brands' %}?client_id=${clientId}`)
        .then(r => r.json())
        .then(data => {
            (data.brands || []).forEach(b => {
                brandSel.insertAdjacentHTML('beforeend',
                    `<option value="${b.id}">${escapeHtml(b.name)}</option>`);
            });
        });
}

// ============================================================================
// 주문 목록
// ============================================================================
function loadOrders(page) {
    if (page) currentPage = page;

    const params = new URLSearchParams();
    params.append('page', currentPage);
    params.append('page_size', 30);

    const clientFilter = document.getElementById('filterClient');
    if (clientFilter?.value) params.append('client_id', clientFilter.value);

    const brandFilter = document.getElementById('filterBrand');
    if (brandFilter?.value) params.append('brand_id', brandFilter.value);

    const platform = document.getElementById('filterPlatform').value;
    if (platform) params.append('platform', platform);

    const status = document.getElementById('filterStatus').value;
    if (status) params.append('status', status);

    const search = document.getElementById('filterSearch').value.trim();
    if (search) params.append('search', search);

    showLoading(true);

    fetch(`{% url 'fulfillment:get_orders' %}?${params.toString()}`)
        .then(r => r.json())
        .then(data => {
            showLoading(false);
            ordersData = data.orders;
            renderOrders(data);
        })
        .catch(err => {
            showLoading(false);
            showToast('목록 로드 실패', 'danger');
        });
}

function renderOrders(data) {
    const tbody = document.getElementById('ordersBody');
    const emptyState = document.getElementById('emptyState');
    const paginationArea = document.getElementById('paginationArea');
    const totalInfo = document.getElementById('totalInfo');

    totalInfo.textContent = `총 ${data.total.toLocaleString()}건`;

    if (data.orders.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('d-none');
        paginationArea.style.display = 'none !important';
        return;
    }

    emptyState.classList.add('d-none');
    paginationArea.style.cssText = '';

    let html = '';
    data.orders.forEach(order => {
        const confirmCheck = getStatusCheckHtml(order, 'confirm',
            order.status !== 'pending', order.confirmed_at,
            order.status === 'pending' && CAN_MANAGE);
        const shipCheck = getStatusCheckHtml(order, 'ship',
            ['shipped','synced'].includes(order.status), order.shipped_at,
            order.status === 'confirmed' && CAN_MANAGE);
        const syncCheck = getStatusCheckHtml(order, 'sync',
            order.status === 'synced', order.synced_at,
            order.status === 'shipped' && CAN_MANAGE);

        html += `
        <tr>
            <td>
                <a href="javascript:void(0)" onclick="showDetail(${order.id})" class="text-decoration-none fw-semibold text-primary">
                    ${escapeHtml(order.order_number)}
                </a>
            </td>
            <td>${escapeHtml(order.order_type)}</td>
            <td>${escapeHtml(order.order_confirmed)}</td>
            <td>${escapeHtml(order.client_name)}</td>
            <td>${escapeHtml(order.brand_name)}</td>
            <td><span class="badge-platform ${order.platform}">${escapeHtml(order.platform_display)}</span></td>
            <td>${escapeHtml(order.sku_id)}</td>
            <td class="text-truncate" style="max-width:180px;" title="${escapeHtml(order.product_name)}">
                ${escapeHtml(order.product_name)}
            </td>
            <td>${escapeHtml(order.barcode)}</td>
            <td>${escapeHtml(order.center)}</td>
            <td>${escapeHtml(order.receiving_date)}</td>
            <td>${escapeHtml(order.order_date)}</td>
            <td class="text-end">${order.order_quantity.toLocaleString()}</td>
            <td class="text-end">${order.confirmed_quantity.toLocaleString()}</td>
            <td class="text-center">${confirmCheck}</td>
            <td class="text-center">${shipCheck}</td>
            <td class="text-center">${syncCheck}</td>
            ${CAN_MANAGE ? `
            <td>
                <div class="d-flex gap-1">
                    <button class="btn btn-outline-danger btn-action" onclick="deleteOrder(${order.id})" title="삭제">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>` : ''}
        </tr>`;
    });
    tbody.innerHTML = html;
    renderPagination(data);
}

function getStatusCheckHtml(order, action, isDone, timestamp, isClickable) {
    let cls = 'pending';
    let icon = '<i class="bi bi-circle"></i>';
    let title = '';
    let onclick = '';

    if (action === 'confirm' && isDone) { cls = 'confirmed'; icon = '<i class="bi bi-check-lg"></i>'; title = order.confirmed_at ? `확인: ${order.confirmed_at}` : '확인완료'; }
    else if (action === 'ship' && isDone) { cls = 'shipped'; icon = '<i class="bi bi-check-lg"></i>'; title = order.shipped_at ? `출고: ${order.shipped_at}` : '출고완료'; }
    else if (action === 'sync' && isDone) { cls = 'synced'; icon = '<i class="bi bi-check-lg"></i>'; title = order.synced_at ? `전산: ${order.synced_at}` : '전산반영'; }

    if (isClickable) {
        cls += ' clickable';
        onclick = `onclick="changeStatus(${order.id}, '${action}')"`;
        title = action === 'confirm' ? '클릭하여 확인' : action === 'ship' ? '클릭하여 출고' : '클릭하여 전산반영';
    } else if (!isDone) { cls += ' disabled'; }

    return `<span class="status-check ${cls}" ${onclick} title="${title}">${icon}</span>`;
}

function renderPagination(data) {
    const pageInfo = document.getElementById('pageInfo');
    const pagination = document.getElementById('pagination');
    pageInfo.textContent = `${data.page} / ${data.total_pages} 페이지`;

    let html = `<li class="page-item ${!data.has_previous ? 'disabled' : ''}">
        <a class="page-link" href="javascript:void(0)" onclick="loadOrders(${data.page - 1})"><i class="bi bi-chevron-left"></i></a></li>`;

    const startPage = Math.max(1, data.page - 2);
    const endPage = Math.min(data.total_pages, data.page + 2);
    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === data.page ? 'active' : ''}">
            <a class="page-link" href="javascript:void(0)" onclick="loadOrders(${i})">${i}</a></li>`;
    }

    html += `<li class="page-item ${!data.has_next ? 'disabled' : ''}">
        <a class="page-link" href="javascript:void(0)" onclick="loadOrders(${data.page + 1})"><i class="bi bi-chevron-right"></i></a></li>`;

    pagination.innerHTML = html;
}

// ============================================================================
// 상태 변경
// ============================================================================
function changeStatus(orderId, action) {
    const actionNames = {confirm: '확인완료', ship: '출고완료', sync: '전산반영'};
    if (!confirm(`해당 주문을 "${actionNames[action]}" 처리하시겠습니까?`)) return;

    fetch(`/fulfillment/api/orders/${orderId}/status/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({action: action}),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast(data.message, 'success'); loadOrders(); }
        else showToast(data.error || '처리 실패', 'danger');
    })
    .catch(() => showToast('서버 오류', 'danger'));
}

// ============================================================================
// 붙여넣기 주문 등록
// ============================================================================
function showPasteModal() {
    clearPaste();
    document.getElementById('pastePlatform').value = '';
    if (IS_CLIENT) {
        const sel = document.getElementById('pasteClient');
        if (sel.options.length > 1) {
            sel.value = sel.options[1].value;
            onPasteClientChange();
        }
    } else {
        document.getElementById('pasteClient').value = '';
        document.getElementById('pasteBrand').innerHTML = '<option value="">선택 (선택사항)</option>';
    }
    new bootstrap.Modal(document.getElementById('pasteModal')).show();
}

function onPasteClientChange() {
    const clientId = document.getElementById('pasteClient').value;
    const brandSel = document.getElementById('pasteBrand');
    brandSel.innerHTML = '<option value="">선택 (선택사항)</option>';
    if (!clientId) return;

    fetch(`{% url 'fulfillment:get_brands' %}?client_id=${clientId}`)
        .then(r => r.json())
        .then(data => {
            (data.brands || []).forEach(b => {
                brandSel.insertAdjacentHTML('beforeend',
                    `<option value="${b.id}">${escapeHtml(b.name)}</option>`);
            });
        });
}

function onPasteInput() {
    const text = document.getElementById('pasteTextarea').value.trim();
    const preview = document.getElementById('pastePreview');
    const tbody = document.getElementById('pastePreviewBody');
    const countEl = document.getElementById('pasteRowCount');
    const btn = document.getElementById('btnBulkPaste');

    if (!text) {
        preview.style.display = 'none';
        btn.disabled = true;
        return;
    }

    const lines = text.split('\n').filter(l => l.trim());
    let html = '';
    let count = 0;

    lines.forEach((line, idx) => {
        const cols = line.split('\t');
        count++;
        html += `<tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(cols[0] || '')}</td>
            <td>${escapeHtml(cols[1] || '')}</td>
            <td>${escapeHtml(cols[2] || '')}</td>
            <td>${escapeHtml(cols[3] || '')}</td>
            <td>${escapeHtml(cols[4] || '')}</td>
            <td>${escapeHtml(cols[5] || '')}</td>
            <td>${escapeHtml(cols[6] || '')}</td>
            <td>${escapeHtml(cols[7] || '')}</td>
            <td>${escapeHtml(cols[8] || '')}</td>
            <td>${escapeHtml(cols[9] || '')}</td>
            <td>${escapeHtml(cols[10] || '')}</td>
        </tr>`;
    });

    tbody.innerHTML = html;
    countEl.textContent = count;
    preview.style.display = 'block';
    btn.disabled = count === 0;
}

function clearPaste() {
    document.getElementById('pasteTextarea').value = '';
    document.getElementById('pastePreview').style.display = 'none';
    document.getElementById('pastePreviewBody').innerHTML = '';
    document.getElementById('btnBulkPaste').disabled = true;
}

function submitBulkPaste() {
    const clientId = document.getElementById('pasteClient').value;
    const brandId = document.getElementById('pasteBrand').value;
    const platform = document.getElementById('pastePlatform').value;
    const pasteText = document.getElementById('pasteTextarea').value.trim();

    if (!clientId) { showToast('거래처를 선택해주세요.', 'warning'); return; }
    if (!platform) { showToast('플랫폼을 선택해주세요.', 'warning'); return; }
    if (!pasteText) { showToast('붙여넣기 데이터가 없습니다.', 'warning'); return; }

    const btn = document.getElementById('btnBulkPaste');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>등록 중...';

    fetch('{% url "fulfillment:bulk_paste_orders" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({
            client_id: parseInt(clientId),
            brand_id: brandId ? parseInt(brandId) : null,
            platform: platform,
            paste_text: pasteText,
        }),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>일괄 등록';

        if (data.success) {
            let msg = data.message;
            if (data.error_count) msg += ` (오류 ${data.error_count}건)`;
            showToast(msg, data.error_count ? 'warning' : 'success');

            if (data.errors && data.errors.length > 0) {
                alert('오류 목록:\n' + data.errors.join('\n'));
            }

            bootstrap.Modal.getInstance(document.getElementById('pasteModal')).hide();
            loadOrders();
        } else {
            showToast(data.error || '등록 실패', 'danger');
        }
    })
    .catch(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>일괄 등록';
        showToast('서버 오류', 'danger');
    });
}

// ============================================================================
// 주문 삭제
// ============================================================================
function deleteOrder(orderId) {
    if (!confirm('정말 삭제하시겠습니까?')) return;

    fetch(`/fulfillment/api/orders/${orderId}/delete/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast(data.message, 'success'); loadOrders(); }
        else showToast(data.error || '삭제 실패', 'danger');
    })
    .catch(() => showToast('서버 오류', 'danger'));
}

// ============================================================================
// 상세 보기
// ============================================================================
function showDetail(orderId) {
    const order = ordersData.find(o => o.id === orderId);
    if (!order) return;
    currentDetailOrderId = orderId;

    const statusBadge = {
        pending: '<span class="badge bg-secondary">대기</span>',
        confirmed: '<span class="badge bg-primary">확인완료</span>',
        shipped: '<span class="badge bg-warning text-dark">출고완료</span>',
        synced: '<span class="badge bg-success">전산반영</span>',
    };

    const html = `
    <table class="table table-sm" style="font-size:0.85rem;">
        <tr><td class="text-muted" style="width:100px;">거래처</td><td>${escapeHtml(order.client_name)}</td>
            <td class="text-muted" style="width:100px;">브랜드</td><td>${escapeHtml(order.brand_name) || '-'}</td></tr>
        <tr><td class="text-muted">플랫폼</td><td><span class="badge-platform ${order.platform}">${escapeHtml(order.platform_display)}</span></td>
            <td class="text-muted">상태</td><td>${statusBadge[order.status]}</td></tr>
        <tr><td class="text-muted">발주번호</td><td>${escapeHtml(order.order_number)}</td>
            <td class="text-muted">발주유형</td><td>${escapeHtml(order.order_type)}</td></tr>
        <tr><td class="text-muted">발주확정</td><td>${escapeHtml(order.order_confirmed)}</td>
            <td class="text-muted">SKU ID</td><td>${escapeHtml(order.sku_id)}</td></tr>
        <tr><td class="text-muted">상품명</td><td colspan="3">${escapeHtml(order.product_name)}</td></tr>
        <tr><td class="text-muted">바코드</td><td>${escapeHtml(order.barcode)}</td>
            <td class="text-muted">센터</td><td>${escapeHtml(order.center)}</td></tr>
        <tr><td class="text-muted">입고일</td><td>${escapeHtml(order.receiving_date)}</td>
            <td class="text-muted">발주일시</td><td>${escapeHtml(order.order_date)}</td></tr>
        <tr><td class="text-muted">발주수량</td><td>${order.order_quantity.toLocaleString()}</td>
            <td class="text-muted">확정수량</td><td>${order.confirmed_quantity.toLocaleString()}</td></tr>
        <tr><td colspan="4"><hr class="my-1"></td></tr>
        <tr><td class="text-muted">확인</td><td>${order.confirmed_at || '-'}</td>
            <td class="text-muted">출고</td><td>${order.shipped_at || '-'}</td></tr>
        <tr><td class="text-muted">전산반영</td><td>${order.synced_at || '-'}</td>
            <td class="text-muted">등록자</td><td>${escapeHtml(order.created_by)}</td></tr>
        ${order.memo ? `<tr><td class="text-muted">비고</td><td colspan="3">${escapeHtml(order.memo)}</td></tr>` : ''}
    </table>`;

    document.getElementById('detailModalBody').innerHTML = html;
    document.getElementById('commentInput').value = '';
    new bootstrap.Modal(document.getElementById('detailModal')).show();
    loadComments(orderId);
}

// ============================================================================
// 댓글
// ============================================================================
function loadComments(orderId) {
    const listEl = document.getElementById('commentList');
    const countEl = document.getElementById('commentCount');
    listEl.innerHTML = '<div class="comment-empty"><span class="spinner-border spinner-border-sm me-1"></span>불러오는 중...</div>';

    fetch(`/fulfillment/api/orders/${orderId}/comments/`)
        .then(r => r.json())
        .then(data => {
            const comments = data.comments || [];
            countEl.textContent = `(${comments.length})`;
            if (comments.length === 0) { listEl.innerHTML = '<div class="comment-empty">아직 댓글이 없습니다.</div>'; return; }

            let html = '';
            comments.forEach(c => { html += renderComment(c); });
            listEl.innerHTML = html;
            listEl.scrollTop = listEl.scrollHeight;
        })
        .catch(() => { listEl.innerHTML = '<div class="comment-empty text-danger">댓글을 불러올 수 없습니다.</div>'; });
}

function renderComment(c) {
    if (c.is_system) {
        return `<div class="comment-item system-msg">
            <div class="comment-avatar system"><i class="bi bi-gear-fill"></i></div>
            <div class="comment-body">
                <div class="comment-meta"><span class="comment-time">${c.created_at}</span></div>
                <div class="comment-content">${escapeHtml(c.content)}</div>
            </div></div>`;
    }
    const roleClass = c.author_role === '관리자' ? 'admin' : c.author_role === '거래처' ? 'client' : 'worker';
    const initials = c.author_name ? c.author_name.substring(0, 1) : '?';
    const deleteBtn = (c.is_mine || IS_ADMIN)
        ? `<button class="comment-delete-btn" onclick="deleteComment(${c.id})" title="삭제"><i class="bi bi-x-lg"></i></button>` : '';

    return `<div class="comment-item" id="comment-${c.id}">
        <div class="comment-avatar ${roleClass}">${escapeHtml(initials)}</div>
        <div class="comment-body">
            <div class="comment-meta">
                <span class="comment-author">${escapeHtml(c.author_name)}</span>
                <span class="comment-role">${escapeHtml(c.author_role)}</span>
                <span class="comment-time">${c.created_at}</span>
                ${deleteBtn}
            </div>
            <div class="comment-content">${escapeHtml(c.content)}</div>
        </div></div>`;
}

function addComment() {
    if (!currentDetailOrderId) return;
    const input = document.getElementById('commentInput');
    const content = input.value.trim();
    if (!content) return;
    const btn = input.nextElementSibling;
    btn.disabled = true;

    fetch(`/fulfillment/api/orders/${currentDetailOrderId}/comments/add/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({content}),
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        if (data.success) {
            input.value = '';
            input.style.height = 'auto';
            const listEl = document.getElementById('commentList');
            const emptyEl = listEl.querySelector('.comment-empty');
            if (emptyEl) emptyEl.remove();
            listEl.insertAdjacentHTML('beforeend', renderComment(data.comment));
            listEl.scrollTop = listEl.scrollHeight;
            const countEl = document.getElementById('commentCount');
            const cnt = parseInt(countEl.textContent.replace(/[()]/g, '') || '0');
            countEl.textContent = `(${cnt + 1})`;
        } else showToast(data.error || '댓글 등록 실패', 'danger');
    })
    .catch(() => { btn.disabled = false; showToast('서버 오류', 'danger'); });
}

function deleteComment(commentId) {
    if (!currentDetailOrderId) return;
    if (!confirm('댓글을 삭제하시겠습니까?')) return;

    fetch(`/fulfillment/api/orders/${currentDetailOrderId}/comments/${commentId}/delete/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const el = document.getElementById(`comment-${commentId}`);
            if (el) el.remove();
            const countEl = document.getElementById('commentCount');
            const cnt = Math.max(0, parseInt(countEl.textContent.replace(/[()]/g, '') || '1') - 1);
            countEl.textContent = `(${cnt})`;
            if (cnt === 0) document.getElementById('commentList').innerHTML = '<div class="comment-empty">아직 댓글이 없습니다.</div>';
        } else showToast(data.error || '삭제 실패', 'danger');
    })
    .catch(() => showToast('서버 오류', 'danger'));
}

function handleCommentKeydown(e) {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); addComment(); }
    setTimeout(() => { e.target.style.height = 'auto'; e.target.style.height = Math.min(e.target.scrollHeight, 80) + 'px'; }, 0);
}

// ============================================================================
// 브랜드 관리
// ============================================================================
function showBrandModal() {
    document.getElementById('brandClient').value = '';
    document.getElementById('brandList').innerHTML = '<div class="text-center text-muted py-3" style="font-size:0.85rem;">거래처를 선택하세요</div>';
    document.getElementById('newBrandName').value = '';
    new bootstrap.Modal(document.getElementById('brandModal')).show();
}

function loadBrandsForManage() {
    const clientId = document.getElementById('brandClient').value;
    const listEl = document.getElementById('brandList');
    if (!clientId) {
        listEl.innerHTML = '<div class="text-center text-muted py-3" style="font-size:0.85rem;">거래처를 선택하세요</div>';
        return;
    }

    fetch(`{% url 'fulfillment:get_brands' %}?client_id=${clientId}`)
        .then(r => r.json())
        .then(data => {
            const brands = data.brands || [];
            if (brands.length === 0) {
                listEl.innerHTML = '<div class="text-center text-muted py-3" style="font-size:0.85rem;">등록된 브랜드가 없습니다.</div>';
                return;
            }
            let html = '';
            brands.forEach(b => {
                html += `<div class="brand-item" id="brand-item-${b.id}">
                    <span><i class="bi bi-tag me-2 text-primary"></i>${escapeHtml(b.name)} ${b.code ? `<small class="text-muted">(${escapeHtml(b.code)})</small>` : ''}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteBrand(${b.id})" style="font-size:0.7rem; padding:1px 6px;">
                        <i class="bi bi-x"></i>
                    </button>
                </div>`;
            });
            listEl.innerHTML = html;
        });
}

function addBrand() {
    const clientId = document.getElementById('brandClient').value;
    const nameInput = document.getElementById('newBrandName');
    const name = nameInput.value.trim();

    if (!clientId) { showToast('거래처를 선택하세요.', 'warning'); return; }
    if (!name) { showToast('브랜드명을 입력하세요.', 'warning'); return; }

    fetch('{% url "fulfillment:create_brand" %}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
        body: JSON.stringify({ client_id: parseInt(clientId), name: name }),
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            nameInput.value = '';
            loadBrandsForManage();
        } else showToast(data.error || '등록 실패', 'danger');
    })
    .catch(() => showToast('서버 오류', 'danger'));
}

function deleteBrand(brandId) {
    if (!confirm('브랜드를 삭제하시겠습니까?')) return;

    fetch(`/fulfillment/api/brands/${brandId}/delete/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': CSRF_TOKEN },
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            loadBrandsForManage();
        } else showToast(data.error || '삭제 실패', 'danger');
    })
    .catch(() => showToast('서버 오류', 'danger'));
}

// ============================================================================
// 엑셀 다운로드
// ============================================================================
function exportExcel() {
    const params = new URLSearchParams();
    const clientFilter = document.getElementById('filterClient');
    if (clientFilter?.value) params.append('client_id', clientFilter.value);
    const brandFilter = document.getElementById('filterBrand');
    if (brandFilter?.value) params.append('brand_id', brandFilter.value);
    const platform = document.getElementById('filterPlatform').value;
    if (platform) params.append('platform', platform);
    const status = document.getElementById('filterStatus').value;
    if (status) params.append('status', status);
    const search = document.getElementById('filterSearch').value.trim();
    if (search) params.append('search', search);

    window.location.href = `{% url 'fulfillment:export_excel' %}?${params.toString()}`;
}

// ============================================================================
// 유틸리티
// ============================================================================
function debounceSearch() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { currentPage = 1; loadOrders(); }, 300);
}

function showLoading(show) {
    const overlay = document.getElementById('loadingOverlay');
    if (show) overlay.classList.add('show');
    else overlay.classList.remove('show');
}

function showToast(message, type) {
    const container = document.getElementById('toastContainer');
    const id = 'toast_' + Date.now();
    const icons = { success: 'bi-check-circle-fill', danger: 'bi-exclamation-triangle-fill', warning: 'bi-exclamation-circle-fill', info: 'bi-info-circle-fill' };
    const html = `<div id="${id}" class="toast align-items-center text-bg-${type} border-0 show" role="alert">
        <div class="d-flex"><div class="toast-body"><i class="bi ${icons[type] || icons.info} me-1"></i>${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
    container.insertAdjacentHTML('beforeend', html);
    setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, 3000);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
