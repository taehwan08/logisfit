{% extends 'base.html' %}
{% load static %}

{% block title %}입고관리{% endblock %}
{% block page_title %}입고관리{% endblock %}

{% block extra_css %}
<style>
    .inbound-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    /* 상품 검색 */
    .product-search-wrap {
        position: relative;
    }
    .product-search-wrap .form-control {
        border-radius: 10px;
    }
    .product-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1050;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0 0 10px 10px;
        max-height: 250px;
        overflow-y: auto;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .product-dropdown.show {
        display: block;
    }
    .product-dropdown-item {
        padding: 0.6rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.9rem;
    }
    .product-dropdown-item:hover {
        background: #f0f6ff;
    }
    .product-dropdown-item .barcode {
        font-size: 0.78rem;
        color: #6c757d;
    }

    /* 선택된 상품 */
    .selected-product {
        display: none;
        background: #f0f6ff;
        border: 1px solid #b6d4fe;
        border-radius: 10px;
        padding: 0.75rem 1rem;
    }
    .selected-product.show {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .selected-product .product-info {
        font-weight: 500;
    }
    .selected-product .product-info .barcode {
        font-size: 0.82rem;
        color: #6c757d;
        margin-left: 0.5rem;
    }

    /* 입력 폼 */
    .inbound-form .form-control {
        border-radius: 10px;
    }
    .inbound-form .form-label {
        font-weight: 500;
        font-size: 0.88rem;
        color: #495057;
    }

    /* 필터 탭 */
    .filter-tabs {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    .filter-tab {
        padding: 0.35rem 1rem;
        border-radius: 20px;
        border: 1px solid #dee2e6;
        background: #fff;
        cursor: pointer;
        font-size: 0.85rem;
        color: #495057;
        transition: all 0.2s;
    }
    .filter-tab:hover {
        border-color: #0d6efd;
        color: #0d6efd;
    }
    .filter-tab.active {
        background: #0d6efd;
        color: #fff;
        border-color: #0d6efd;
    }

    /* 테이블 */
    .inbound-table th {
        font-size: 0.82rem;
        font-weight: 600;
        color: #6c757d;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
    }
    .inbound-table td {
        font-size: 0.88rem;
        vertical-align: middle;
    }

    /* 상태 배지 */
    .badge-pending {
        background-color: #fff3cd;
        color: #856404;
    }
    .badge-completed {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .empty-state {
        padding: 3rem;
        text-align: center;
        color: #adb5bd;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    /* 통계 */
    .stat-badge {
        font-size: 1rem;
        font-weight: 700;
    }

    /* 상품명 이미지 아이콘 */
    .product-name-link {
        cursor: pointer;
        color: #0d6efd;
        transition: color 0.2s;
    }
    .product-name-link:hover {
        color: #0a58ca;
        text-decoration: underline;
    }
    .product-name-link .bi-camera {
        font-size: 0.75rem;
        margin-left: 4px;
        opacity: 0.7;
    }

    /* 이미지 갤러리 모달 */
    .gallery-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.85);
        z-index: 10001;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }
    .gallery-overlay.show {
        display: flex;
    }
    .gallery-overlay img {
        max-width: 88vw;
        max-height: 80vh;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        object-fit: contain;
    }
    .gallery-close {
        position: absolute;
        top: 16px;
        right: 20px;
        background: rgba(255,255,255,0.15);
        border: none;
        color: #fff;
        font-size: 1.5rem;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }
    .gallery-close:hover {
        background: rgba(255,255,255,0.3);
    }
    .gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255,255,255,0.15);
        border: none;
        color: #fff;
        font-size: 1.5rem;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }
    .gallery-nav:hover {
        background: rgba(255,255,255,0.3);
    }
    .gallery-nav.prev { left: 16px; }
    .gallery-nav.next { right: 16px; }
    .gallery-counter {
        color: #fff;
        font-size: 0.9rem;
        margin-top: 12px;
        opacity: 0.8;
    }

    /* 다중 이미지 미리보기 */
    .image-preview-list {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
    }
    .image-preview-item {
        position: relative;
        width: 60px;
        height: 60px;
    }
    .image-preview-item img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #dee2e6;
    }
    .image-preview-item .remove-btn {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #dc3545;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 0.65rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        line-height: 1;
    }

    /* 인쇄 버튼 */
    .btn-print-label {
        padding: 0.25rem 0.5rem;
        font-size: 0.82rem;
        border-radius: 6px;
    }

    /* ========================================
       현품표 미리보기 모달
       ======================================== */
    .preview-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 10000;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .preview-overlay.show {
        display: flex;
    }
    .preview-wrapper {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        max-width: 95vw;
        max-height: 95vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    .preview-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 1rem;
        border-bottom: 1px solid #dee2e6;
        background: #f8f9fa;
    }
    .preview-toolbar .preview-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: #333;
    }
    .preview-body {
        padding: 20px;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        background: #e9ecef;
    }
    /* A4 가로 비율 축소판 */
    .preview-page {
        background: #fff;
        width: 792px;   /* 297mm 축소 */
        height: 562px;  /* 210mm 축소 */
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
        padding: 22px 32px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        flex-shrink: 0;
    }
    .preview-page .pv-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #000;
        padding-bottom: 5px;
        margin-bottom: 5px;
    }
    .preview-page .pv-header .pv-date {
        font-size: 10px;
        color: #333;
        flex-shrink: 0;
    }
    .preview-page .pv-header .pv-title {
        font-size: 14px;
        font-weight: 800;
        letter-spacing: 2px;
        flex-shrink: 0;
    }
    .preview-page .pv-header .pv-barcode-area {
        flex-shrink: 0;
    }
    .preview-page .pv-header .pv-barcode-area svg {
        height: 36px;
        width: auto;
    }
    .preview-page .pv-product {
        text-align: center;
        padding: 12px 0;
    }
    .preview-page .pv-product-name {
        font-size: 42px;
        font-weight: 900;
        line-height: 1.15;
        word-break: keep-all;
    }
    .preview-page .pv-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    .preview-page .pv-table th,
    .preview-page .pv-table td {
        border: 2px solid #000;
        text-align: center;
        vertical-align: middle;
    }
    .preview-page .pv-table th {
        font-size: 12px;
        font-weight: 700;
        background: #f0f0f0;
        padding: 4px;
    }
    .preview-page .pv-table td {
        font-size: 38px;
        font-weight: 900;
        padding: 6px 4px;
    }
    .preview-page .pv-table td.pv-qty {
        font-size: 52px;
    }

    /* ========================================
       현품표 인쇄 전용 스타일
       ======================================== */

    /* 화면에서는 숨김 */
    #printLabelContainer {
        display: none;
    }

    @media print {
        /* 사이드바, 네비바, 푸터, 메시지 등 전부 숨김 */
        .wrapper > .sidebar,
        .main-content > nav,
        .main-content > .alert,
        .main-content > footer,
        #messages-container,
        .sidebar,
        .navbar,
        footer {
            display: none !important;
        }

        /* 메인 콘텐츠 영역 리셋 */
        .wrapper,
        .main-content,
        .main-content > main {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        /* 카드들(입고 등록/입고 기록) 숨김 */
        .row.g-4 {
            display: none !important;
        }

        /* 미리보기 모달 숨김 */
        .preview-overlay {
            display: none !important;
        }

        /* 현품표만 표시 — A4 가로 */
        #printLabelContainer {
            display: block !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 297mm;
            height: 210mm;
            margin: 0;
            padding: 8mm 12mm;
            box-sizing: border-box;
            background: #fff;
            z-index: 99999;
        }

        .print-label {
            width: 100%;
            height: 100%;
            display: flex !important;
            flex-direction: column;
            justify-content: space-between;
        }

        /* 헤더: 입고일 | 현 품 표 | 바코드 */
        .print-label-header {
            display: flex !important;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 2mm;
            margin-bottom: 2mm;
        }
        .print-label-header .label-date {
            font-size: 11pt;
            color: #333;
            font-weight: 500;
            flex-shrink: 0;
        }
        .print-label-header .label-title {
            font-size: 16pt;
            font-weight: 800;
            color: #000;
            letter-spacing: 2px;
            flex-shrink: 0;
        }
        .print-label-header .label-barcode-area {
            flex-shrink: 0;
        }
        .print-label-header .label-barcode-area svg {
            height: 18mm;
            width: auto;
        }

        /* 상품명 — 최대 크기 */
        .print-product-row {
            text-align: center;
            padding: 5mm 0;
        }
        .print-product-row .label-product-name {
            font-size: 60pt;
            font-weight: 900;
            line-height: 1.15;
            color: #000;
            word-break: keep-all;
        }

        /* 정보 테이블: 입고수량(2×1) + 로트번호(1×1) + 유통기한(1×1) */
        .print-info-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .print-info-table th,
        .print-info-table td {
            border: 2px solid #000;
            text-align: center;
            vertical-align: middle;
        }
        .print-info-table th {
            font-size: 15pt;
            font-weight: 700;
            background: #f0f0f0;
            color: #000;
            padding: 2mm 2mm;
        }
        .print-info-table td {
            font-size: 60pt;
            font-weight: 900;
            color: #000;
            padding: 3mm 2mm;
        }
        #printQuantity {
            font-size: 100pt;
        }

        @page {
            size: A4 landscape;
            margin: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">

    <!-- 입고 등록 카드 -->
    <div class="col-12">
        <div class="card inbound-card">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="bi bi-box-arrow-in-down me-2"></i>입고 등록</h5>
            </div>
            <div class="card-body">
                <div class="inbound-form">
                    <!-- 상품 검색 -->
                    <div class="mb-3">
                        <label class="form-label">상품 검색 <span class="text-danger">*</span></label>
                        <div class="product-search-wrap">
                            <input type="text" id="productSearch" class="form-control"
                                   placeholder="상품명 또는 바코드를 입력하세요" autocomplete="off">
                            <div id="productDropdown" class="product-dropdown"></div>
                        </div>
                        <div id="selectedProduct" class="selected-product mt-2">
                            <div class="product-info">
                                <span id="selectedProductName"></span>
                                <span class="barcode" id="selectedProductBarcode"></span>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearProduct()">
                                <i class="bi bi-x"></i> 취소
                            </button>
                        </div>
                        <input type="hidden" id="selectedProductId" value="">
                    </div>

                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <label class="form-label">입고수량 <span class="text-danger">*</span></label>
                            <input type="number" id="inboundQuantity" class="form-control"
                                   min="1" placeholder="수량">
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label">유통기한</label>
                            <input type="text" id="inboundExpiry" class="form-control"
                                   placeholder="예: 2026-12-31">
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label">로트번호</label>
                            <input type="text" id="inboundLot" class="form-control"
                                   placeholder="로트번호">
                        </div>
                        <div class="col-md-3 col-6">
                            <label class="form-label">메모</label>
                            <input type="text" id="inboundMemo" class="form-control"
                                   placeholder="메모 (선택)">
                        </div>
                    </div>

                    <!-- 이미지 업로드 (다중) -->
                    <div class="mt-3">
                        <label class="form-label">입고 이미지</label>
                        <div class="d-flex align-items-center gap-3">
                            <label class="btn btn-outline-secondary btn-sm" for="inboundImages" style="cursor:pointer;">
                                <i class="bi bi-camera me-1"></i>사진 선택
                            </label>
                            <input type="file" id="inboundImages" accept="image/*" multiple style="display:none;" onchange="previewImages(this)">
                            <span id="imageFileName" class="text-muted" style="font-size:0.82rem;">선택된 파일 없음</span>
                            <button type="button" id="btnRemoveImages" class="btn btn-outline-danger btn-sm" style="display:none;" onclick="removeAllImages()">
                                <i class="bi bi-x me-1"></i>전체 삭제
                            </button>
                        </div>
                        <div id="imagePreviewList" class="image-preview-list"></div>
                    </div>

                    <div class="mt-3 text-end">
                        <button type="button" class="btn btn-primary px-4" onclick="createInbound()" id="btnCreateInbound">
                            <i class="bi bi-plus-lg me-1"></i> 입고 등록
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 입고 기록 카드 -->
    <div class="col-12">
        <div class="card inbound-card">
            <div class="card-header bg-white py-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="d-flex align-items-center gap-3">
                        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>입고 기록</h5>
                        <span class="stat-badge text-primary" id="recordCount">0</span>
                    </div>
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <div class="filter-tabs">
                            <button class="filter-tab active" data-status="" onclick="setFilter(this)">전체</button>
                            <button class="filter-tab" data-status="pending" onclick="setFilter(this)">대기</button>
                            <button class="filter-tab" data-status="completed" onclick="setFilter(this)">전산등록완료</button>
                        </div>
                        <input type="text" id="recordSearch" class="form-control form-control-sm"
                               style="width: 200px; border-radius: 10px;"
                               placeholder="상품명/바코드 검색" oninput="debounceLoadRecords()">
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 inbound-table">
                        <thead>
                            <tr>
                                <th class="ps-3">상품명</th>
                                <th>바코드</th>
                                <th class="text-center">수량</th>
                                <th>유통기한</th>
                                <th>로트번호</th>
                                <th class="text-center">상태</th>
                                <th>등록자</th>
                                <th>등록일시</th>
                                <th>전산처리</th>
                                <th class="text-center">현품표</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                            <tr>
                                <td colspan="10" class="empty-state">
                                    <i class="bi bi-inbox d-block"></i>
                                    입고 기록이 없습니다.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 이미지 갤러리 모달 -->
<div id="galleryOverlay" class="gallery-overlay">
    <button class="gallery-close" onclick="closeGallery()" title="닫기"><i class="bi bi-x-lg"></i></button>
    <button class="gallery-nav prev" onclick="galleryPrev()" id="galleryPrevBtn"><i class="bi bi-chevron-left"></i></button>
    <img id="galleryImg" src="" alt="입고 이미지">
    <button class="gallery-nav next" onclick="galleryNext()" id="galleryNextBtn"><i class="bi bi-chevron-right"></i></button>
    <div class="gallery-counter" id="galleryCounter"></div>
</div>

<!-- 현품표 미리보기 모달 -->
<div id="previewOverlay" class="preview-overlay" onclick="closePreviewOnOverlay(event)">
    <div class="preview-wrapper">
        <div class="preview-toolbar">
            <span class="preview-title"><i class="bi bi-eye me-1"></i>현품표 미리보기</span>
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" onclick="printFromPreview()">
                    <i class="bi bi-printer me-1"></i>인쇄
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="closePreview()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
        </div>
        <div class="preview-body">
            <div class="preview-page">
                <div class="pv-header">
                    <div class="pv-date" id="pvDate"></div>
                    <div class="pv-title">현 품 표</div>
                    <div class="pv-barcode-area"><svg id="pvBarcode"></svg></div>
                </div>
                <div class="pv-product">
                    <div class="pv-product-name" id="pvProductName"></div>
                </div>
                <table class="pv-table">
                    <tr><th colspan="2">입고수량</th></tr>
                    <tr><td colspan="2" class="pv-qty" id="pvQuantity"></td></tr>
                    <tr><th>로트번호</th><th>유통기한</th></tr>
                    <tr>
                        <td id="pvLot"></td>
                        <td id="pvExpiry"></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 현품표 인쇄용 (화면에서 숨김, 인쇄 시만 표시) -->
<div id="printLabelContainer">
    <div class="print-label">
        <!-- 헤더: 입고일 | 현 품 표 | 바코드 -->
        <div class="print-label-header">
            <div class="label-date" id="printDate"></div>
            <div class="label-title">현 품 표</div>
            <div class="label-barcode-area"><svg id="printBarcode"></svg></div>
        </div>

        <!-- 상품명 -->
        <div class="print-product-row">
            <div class="label-product-name" id="printProductName"></div>
        </div>

        <!-- 정보 테이블: 입고수량(2×1) + 로트번호/유통기한(1×1) -->
        <table class="print-info-table">
            <tr>
                <th colspan="2">입고수량</th>
            </tr>
            <tr>
                <td colspan="2" id="printQuantity"></td>
            </tr>
            <tr>
                <th>로트번호</th>
                <th>유통기한</th>
            </tr>
            <tr>
                <td id="printLot"></td>
                <td id="printExpiry"></td>
            </tr>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- JsBarcode CDN -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
<script>
const csrfToken = '{{ csrf_token }}';

let selectedProductId = null;
let currentFilter = '';
let searchTimer = null;
let cachedRecords = [];  // 현품표 인쇄용 레코드 캐시

// ============================================================================
// 상품 검색
// ============================================================================

const productSearchInput = document.getElementById('productSearch');
const productDropdown = document.getElementById('productDropdown');
let searchTimeout = null;

productSearchInput.addEventListener('input', function() {
    const query = this.value.trim();
    clearTimeout(searchTimeout);

    if (query.length < 1) {
        productDropdown.classList.remove('show');
        return;
    }

    searchTimeout = setTimeout(() => {
        fetch(`/inventory/api/products/?search=${encodeURIComponent(query)}`)
            .then(r => r.json())
            .then(data => {
                if (data.products && data.products.length > 0) {
                    productDropdown.innerHTML = data.products.map(p => `
                        <div class="product-dropdown-item" onclick="selectProduct(${p.id}, '${escapeHtml(p.name)}', '${escapeHtml(p.barcode)}')">
                            <div>${escapeHtml(p.display_name || p.name)}</div>
                            <div class="barcode">${escapeHtml(p.barcode)}</div>
                        </div>
                    `).join('');
                    productDropdown.classList.add('show');
                } else {
                    productDropdown.innerHTML = '<div class="product-dropdown-item text-muted">검색 결과가 없습니다.</div>';
                    productDropdown.classList.add('show');
                }
            })
            .catch(() => {
                productDropdown.classList.remove('show');
            });
    }, 300);
});

// 외부 클릭 시 드롭다운 닫기
document.addEventListener('click', function(e) {
    if (!e.target.closest('.product-search-wrap')) {
        productDropdown.classList.remove('show');
    }
});

function selectProduct(id, name, barcode) {
    selectedProductId = id;
    document.getElementById('selectedProductId').value = id;
    document.getElementById('selectedProductName').textContent = name;
    document.getElementById('selectedProductBarcode').textContent = barcode;
    document.getElementById('selectedProduct').classList.add('show');
    productSearchInput.value = '';
    productSearchInput.style.display = 'none';
    productDropdown.classList.remove('show');
}

function clearProduct() {
    selectedProductId = null;
    document.getElementById('selectedProductId').value = '';
    document.getElementById('selectedProduct').classList.remove('show');
    productSearchInput.style.display = '';
    productSearchInput.value = '';
    productSearchInput.focus();
}

// ============================================================================
// 입고 등록
// ============================================================================

function createInbound() {
    if (!selectedProductId) {
        alert('상품을 선택해주세요.');
        return;
    }

    const quantity = document.getElementById('inboundQuantity').value;
    if (!quantity || parseInt(quantity) < 1) {
        alert('입고 수량을 입력해주세요.');
        return;
    }

    const btn = document.getElementById('btnCreateInbound');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 등록 중...';

    const formData = new FormData();
    formData.append('product_id', selectedProductId);
    formData.append('quantity', parseInt(quantity));
    formData.append('expiry_date', document.getElementById('inboundExpiry').value.trim());
    formData.append('lot_number', document.getElementById('inboundLot').value.trim());
    formData.append('memo', document.getElementById('inboundMemo').value.trim());

    // 다중 이미지 첨부
    const imageFiles = document.getElementById('inboundImages').files;
    for (let i = 0; i < imageFiles.length; i++) {
        formData.append('images', imageFiles[i]);
    }

    fetch('/inventory/api/inbound/create/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
        },
        body: formData,
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // 입력 초기화
            clearProduct();
            document.getElementById('inboundQuantity').value = '';
            document.getElementById('inboundExpiry').value = '';
            document.getElementById('inboundLot').value = '';
            document.getElementById('inboundMemo').value = '';
            removeAllImages();
            loadRecords();
            showToast(data.message, 'success');
        } else {
            alert(data.error || '등록에 실패했습니다.');
        }
    })
    .catch(() => {
        alert('네트워크 오류가 발생했습니다.');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-plus-lg me-1"></i> 입고 등록';
    });
}

// ============================================================================
// 입고 기록 조회
// ============================================================================

function setFilter(btn) {
    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.status;
    loadRecords();
}

function debounceLoadRecords() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(loadRecords, 300);
}

function loadRecords() {
    const search = document.getElementById('recordSearch').value.trim();
    let url = `/inventory/api/inbound/?status=${encodeURIComponent(currentFilter)}`;
    if (search) {
        url += `&search=${encodeURIComponent(search)}`;
    }

    fetch(url)
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('recordsBody');
            document.getElementById('recordCount').textContent = data.records.length + '건';
            cachedRecords = data.records;  // 인쇄용 캐시

            if (data.records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="bi bi-inbox d-block"></i>
                            입고 기록이 없습니다.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.records.map((r, idx) => `
                <tr>
                    <td class="ps-3">
                        <div>
                            <div class="fw-medium ${r.has_images ? 'product-name-link' : ''}"
                                 ${r.has_images ? `onclick="openGallery(${idx})" title="사진 보기"` : ''}>
                                ${escapeHtml(r.product_name)}${r.has_images ? '<i class="bi bi-camera"></i>' : ''}
                            </div>
                            ${r.product_display_name && r.product_display_name !== r.product_name
                                ? `<small class="text-muted">${escapeHtml(r.product_display_name)}</small>`
                                : ''}
                            ${r.memo ? `<div class="text-muted" style="font-size:0.78rem;"><i class="bi bi-chat-text me-1"></i>${escapeHtml(r.memo)}</div>` : ''}
                        </div>
                    </td>
                    <td><code style="font-size:0.82rem;">${escapeHtml(r.product_barcode)}</code></td>
                    <td class="text-center fw-bold">${r.quantity.toLocaleString()}</td>
                    <td>${escapeHtml(r.expiry_date || '-')}</td>
                    <td>${escapeHtml(r.lot_number || '-')}</td>
                    <td class="text-center">
                        <span class="badge ${r.status === 'completed' ? 'badge-completed' : 'badge-pending'}">
                            ${escapeHtml(r.status_display)}
                        </span>
                    </td>
                    <td>${escapeHtml(r.registered_by)}</td>
                    <td style="font-size:0.82rem;">${escapeHtml(r.created_at)}</td>
                    <td>
                        ${r.status === 'completed' && r.completed_by
                            ? `<div style="font-size:0.82rem;">
                                 <div>${escapeHtml(r.completed_by)}</div>
                                 <div class="text-muted">${escapeHtml(r.completed_at)}</div>
                               </div>`
                            : r.status === 'pending'
                                ? `<span class="text-muted" style="font-size:0.82rem;">슬랙에서 처리</span>`
                                : ''
                        }
                    </td>
                    <td class="text-center text-nowrap">
                        <button class="btn btn-outline-info btn-print-label me-1"
                                onclick="previewLabel(${idx})" title="미리보기">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-outline-secondary btn-print-label"
                                onclick="printLabel(${idx})" title="인쇄">
                            <i class="bi bi-printer"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(() => {
            document.getElementById('recordsBody').innerHTML = `
                <tr>
                    <td colspan="10" class="text-center text-danger py-4">
                        데이터를 불러오는데 실패했습니다.
                    </td>
                </tr>
            `;
        });
}

// ============================================================================
// 현품표 미리보기
// ============================================================================

let previewIdx = null;

function previewLabel(idx) {
    const record = cachedRecords[idx];
    if (!record) return;
    previewIdx = idx;

    document.getElementById('pvProductName').textContent = record.product_name || '';
    document.getElementById('pvQuantity').textContent = record.quantity ? record.quantity.toLocaleString() : '-';
    document.getElementById('pvExpiry').textContent = record.expiry_date || '-';
    document.getElementById('pvLot').textContent = record.lot_number || '-';
    document.getElementById('pvDate').textContent = '입고일: ' + (record.created_at || '');

    const barcodeSvg = document.getElementById('pvBarcode');
    const barcodeValue = record.product_barcode || '0000000000000';
    try {
        JsBarcode(barcodeSvg, barcodeValue, {
            format: 'CODE128',
            width: 1.5,
            height: 32,
            displayValue: true,
            fontSize: 11,
            font: 'monospace',
            fontOptions: 'bold',
            textMargin: 2,
            margin: 2,
        });
    } catch (e) {
        barcodeSvg.innerHTML = '';
    }

    document.getElementById('previewOverlay').classList.add('show');
}

function closePreview() {
    document.getElementById('previewOverlay').classList.remove('show');
    previewIdx = null;
}

function closePreviewOnOverlay(e) {
    if (e.target === document.getElementById('previewOverlay')) {
        closePreview();
    }
}

function printFromPreview() {
    if (previewIdx !== null) {
        closePreview();
        printLabel(previewIdx);
    }
}

// ============================================================================
// 현품표 인쇄
// ============================================================================

function printLabel(idx) {
    const record = cachedRecords[idx];
    if (!record) return;

    // 현품표 데이터 채우기
    document.getElementById('printProductName').textContent = record.product_name || '';
    document.getElementById('printQuantity').textContent = record.quantity ? record.quantity.toLocaleString() : '-';
    document.getElementById('printExpiry').textContent = record.expiry_date || '-';
    document.getElementById('printLot').textContent = record.lot_number || '-';
    document.getElementById('printDate').textContent = '입고일: ' + (record.created_at || '');

    // 바코드 생성 (헤더 영역에 배치)
    const barcodeSvg = document.getElementById('printBarcode');
    const barcodeValue = record.product_barcode || '0000000000000';

    try {
        JsBarcode(barcodeSvg, barcodeValue, {
            format: 'CODE128',
            width: 2.5,
            height: 60,
            displayValue: true,
            fontSize: 18,
            font: 'monospace',
            fontOptions: 'bold',
            textMargin: 3,
            margin: 3,
        });
    } catch (e) {
        barcodeSvg.innerHTML = '';
        console.warn('바코드 생성 실패:', e);
    }

    // 인쇄 실행
    setTimeout(() => {
        window.print();
    }, 200);
}

// ============================================================================
// 다중 이미지 미리보기 (업로드 폼)
// ============================================================================

function previewImages(input) {
    const files = input.files;
    const previewList = document.getElementById('imagePreviewList');
    previewList.innerHTML = '';

    if (files.length === 0) {
        document.getElementById('imageFileName').textContent = '선택된 파일 없음';
        document.getElementById('btnRemoveImages').style.display = 'none';
        return;
    }

    document.getElementById('imageFileName').textContent = `${files.length}개 파일 선택됨`;
    document.getElementById('btnRemoveImages').style.display = '';

    Array.from(files).forEach((file, i) => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const item = document.createElement('div');
            item.className = 'image-preview-item';
            item.innerHTML = `<img src="${e.target.result}" alt="미리보기">`;
            previewList.appendChild(item);
        };
        reader.readAsDataURL(file);
    });
}

function removeAllImages() {
    document.getElementById('inboundImages').value = '';
    document.getElementById('imageFileName').textContent = '선택된 파일 없음';
    document.getElementById('btnRemoveImages').style.display = 'none';
    document.getElementById('imagePreviewList').innerHTML = '';
}

// ============================================================================
// 이미지 갤러리 모달
// ============================================================================

let galleryImages = [];
let galleryIndex = 0;

function openGallery(recordIdx) {
    const record = cachedRecords[recordIdx];
    if (!record || !record.images || record.images.length === 0) return;

    galleryImages = record.images;
    galleryIndex = 0;
    updateGallery();
    document.getElementById('galleryOverlay').classList.add('show');
}

function updateGallery() {
    const img = document.getElementById('galleryImg');
    const counter = document.getElementById('galleryCounter');
    const prevBtn = document.getElementById('galleryPrevBtn');
    const nextBtn = document.getElementById('galleryNextBtn');

    img.src = galleryImages[galleryIndex].url;
    counter.textContent = `${galleryIndex + 1} / ${galleryImages.length}`;

    prevBtn.style.display = galleryImages.length > 1 ? '' : 'none';
    nextBtn.style.display = galleryImages.length > 1 ? '' : 'none';
}

function galleryPrev() {
    galleryIndex = (galleryIndex - 1 + galleryImages.length) % galleryImages.length;
    updateGallery();
}

function galleryNext() {
    galleryIndex = (galleryIndex + 1) % galleryImages.length;
    updateGallery();
}

function closeGallery() {
    document.getElementById('galleryOverlay').classList.remove('show');
    galleryImages = [];
    galleryIndex = 0;
}

// 갤러리 오버레이 클릭 시 닫기 (이미지/버튼 제외)
document.getElementById('galleryOverlay').addEventListener('click', function(e) {
    if (e.target === this) {
        closeGallery();
    }
});

// ============================================================================
// 유틸리티
// ============================================================================

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(message, type) {
    // 기존 토스트 제거
    const old = document.querySelector('.inbound-toast');
    if (old) old.remove();

    const toast = document.createElement('div');
    toast.className = `inbound-toast alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 280px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${escapeHtml(message)}
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// ESC 키로 모달 닫기
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePreview();
        closeGallery();
    }
    // 갤러리 좌우 키보드 탐색
    if (galleryImages.length > 1) {
        if (e.key === 'ArrowLeft') galleryPrev();
        if (e.key === 'ArrowRight') galleryNext();
    }
});

// 페이지 로드 시 기록 조회
document.addEventListener('DOMContentLoaded', loadRecords);
</script>
{% endblock %}
