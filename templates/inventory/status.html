{% extends 'base.html' %}
{% load static %}

{% block title %}재고 현황{% endblock %}
{% block page_title %}재고 현황 조회{% endblock %}

{% block extra_css %}
<style>
    .status-card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .filter-bar {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem 1.25rem;
    }
    .nav-tabs .nav-link {
        font-weight: 600;
        color: #6c757d;
        border: none;
        padding: 0.75rem 1.5rem;
    }
    .nav-tabs .nav-link.active {
        color: #0d6efd;
        border-bottom: 3px solid #0d6efd;
        background: transparent;
    }

    /* 그룹 카드 */
    .group-card {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        margin-bottom: 1rem;
        overflow: hidden;
    }
    .group-header {
        background: #f8f9fa;
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        transition: background 0.2s;
    }
    .group-header:hover {
        background: #e9ecef;
    }
    .group-header .group-title {
        font-weight: 600;
        font-size: 0.95rem;
    }
    .group-header .group-badge {
        font-size: 0.8rem;
    }
    .group-body {
        border-top: 1px solid #e9ecef;
    }
    .group-table {
        margin-bottom: 0;
        font-size: 0.85rem;
    }
    .group-table th {
        font-size: 0.78rem;
        font-weight: 600;
        color: #6c757d;
        background: #fafafa;
    }
    .group-table td {
        vertical-align: middle;
    }
    .group-table .product-name {
        white-space: nowrap;
    }

    /* 통계 */
    .stat-item {
        text-align: center;
        padding: 0.5rem;
    }
    .stat-item .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #0d6efd;
    }
    .stat-item .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .empty-state {
        padding: 3rem;
        text-align: center;
        color: #adb5bd;
    }
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    /* 트리맵 */
    .treemap-wrapper {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    .treemap-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        padding: 0.5rem 0;
    }
    .treemap-legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.82rem;
        color: #495057;
    }
    .treemap-legend-swatch {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    .treemap-container {
        width: 100%;
        height: 500px;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        background: #fafafa;
    }
    .treemap-container svg {
        width: 100%;
        height: 100%;
    }
    .treemap-cell {
        cursor: pointer;
        transition: opacity 0.15s;
    }
    .treemap-cell:hover {
        opacity: 0.85;
    }
    .treemap-cell.selected rect {
        stroke: #000 !important;
        stroke-width: 3px !important;
    }
    .treemap-cell text {
        pointer-events: none;
        font-family: 'Noto Sans KR', sans-serif;
    }
    .treemap-tooltip {
        position: fixed;
        background: rgba(33, 37, 41, 0.95);
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 0.82rem;
        pointer-events: none;
        z-index: 9999;
        max-width: 280px;
        line-height: 1.5;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        display: none;
    }
    .treemap-tooltip .tt-title {
        font-weight: 700;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }
    .treemap-tooltip .tt-zone {
        color: #adb5bd;
        font-size: 0.75rem;
    }
    .treemap-tooltip .tt-qty {
        font-weight: 700;
        color: #69b4ff;
    }
    .treemap-tooltip .tt-products {
        margin-top: 6px;
        border-top: 1px solid rgba(255,255,255,0.15);
        padding-top: 6px;
    }
    .treemap-detail {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }
    .treemap-detail-header {
        background: #f8f9fa;
        padding: 0.75rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .treemap-detail-header .detail-title {
        font-weight: 600;
        font-size: 0.95rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- 필터 바 -->
    <div class="col-12">
        <div class="filter-bar">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small fw-medium">세션 선택</label>
                    <select class="form-select" id="sessionSelect" onchange="onSessionChange()">
                        <option value="">세션을 선택하세요</option>
                        {% for s in sessions %}
                        <option value="{{ s.pk }}"
                            {% if active_session and s.pk == active_session.pk %}selected{% endif %}>
                            {{ s.name }}
                            {% if s.status == 'active' %}(진행중){% else %}(종료){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small fw-medium">검색</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput"
                               placeholder="로케이션, 상품명, 바코드 검색">
                        <button class="btn btn-outline-secondary" onclick="loadRecords()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex gap-3 justify-content-end" id="statsArea">
                        <div class="stat-item">
                            <div class="stat-value" id="statLocations">-</div>
                            <div class="stat-label">로케이션</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statProducts">-</div>
                            <div class="stat-label">상품종류</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="statQuantity">-</div>
                            <div class="stat-label">총수량</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 탭 + 데이터 -->
    <div class="col-12">
        <div class="card status-card">
            <div class="card-header bg-white border-bottom-0 pt-3 pb-0 d-flex justify-content-between align-items-end">
                <ul class="nav nav-tabs" id="viewTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-tab="location" onclick="switchTab('location')">
                            <i class="bi bi-geo-alt me-1"></i>로케이션별
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-tab="product" onclick="switchTab('product')">
                            <i class="bi bi-box-seam me-1"></i>상품별
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-tab="treemap" onclick="switchTab('treemap')">
                            <i class="bi bi-grid-1x2 me-1"></i>시각화
                        </button>
                    </li>
                </ul>
                <button class="btn btn-outline-success btn-sm mb-2" id="exportBtn" onclick="exportExcel()" disabled>
                    <i class="bi bi-file-earmark-excel me-1"></i>엑셀 다운로드
                </button>
            </div>
            <div class="card-body p-4" id="dataContainer">
                <div class="empty-state">
                    <i class="bi bi-bar-chart-line d-block"></i>
                    <p class="mb-0">세션을 선택하면 재고 현황이 표시됩니다.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- D3.js for treemap visualization -->
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script>
const csrfToken = '{{ csrf_token }}';
let currentTab = 'location';
let currentData = { groups: [] };
let treemapLocationData = null;  // 시각화 탭용 location 데이터 캐시

document.addEventListener('DOMContentLoaded', function() {
    // URL에서 session_id 파라미터 확인
    const params = new URLSearchParams(window.location.search);
    const sessionId = params.get('session_id');
    if (sessionId) {
        document.getElementById('sessionSelect').value = sessionId;
    }

    // 세션이 선택되어 있으면 자동 로드
    if (document.getElementById('sessionSelect').value) {
        loadRecords();
    }

    // 검색 Enter 키
    document.getElementById('searchInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') loadRecords();
    });
});

function onSessionChange() {
    loadRecords();
}

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('#viewTabs .nav-link').forEach(el => {
        el.classList.toggle('active', el.dataset.tab === tab);
    });

    // 시각화 탭에서 캐시된 location 데이터가 있으면 바로 렌더링
    if (tab === 'treemap' && treemapLocationData) {
        renderTreemap(treemapLocationData);
        updateStats(treemapLocationData);
        return;
    }
    loadRecords();
}

async function loadRecords() {
    const sessionId = document.getElementById('sessionSelect').value;
    if (!sessionId) {
        document.getElementById('dataContainer').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-bar-chart-line d-block"></i>
                <p class="mb-0">세션을 선택하면 재고 현황이 표시됩니다.</p>
            </div>`;
        updateStats(null);
        return;
    }

    const search = document.getElementById('searchInput').value.trim();
    // 시각화 탭은 항상 location 기준으로 데이터 가져오기
    const groupBy = currentTab === 'treemap' ? 'location' : currentTab;
    const params = new URLSearchParams({
        session_id: sessionId,
        group_by: groupBy,
    });
    if (search) params.append('search', search);

    try {
        document.getElementById('dataContainer').innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">불러오는 중...</p>
            </div>`;

        const resp = await fetch(`{% url "inventory:get_records" %}?${params.toString()}`);
        const data = await resp.json();
        currentData = data;

        if (currentTab === 'treemap') {
            treemapLocationData = data.groups || [];
            renderTreemap(treemapLocationData);
        } else if (currentTab === 'location') {
            renderByLocation(data.groups || []);
        } else {
            renderByProduct(data.groups || []);
        }

        updateStats(data.groups || []);
        // 데이터가 있으면 엑셀 다운로드 버튼 활성화
        document.getElementById('exportBtn').disabled = !(data.groups && data.groups.length);
    } catch (e) {
        console.error('기록 로드 실패:', e);
        document.getElementById('exportBtn').disabled = true;
        document.getElementById('dataContainer').innerHTML = `
            <div class="empty-state">
                <i class="bi bi-exclamation-circle d-block text-danger"></i>
                <p class="mb-0">데이터를 불러오는 중 오류가 발생했습니다.</p>
            </div>`;
    }
}

function renderByLocation(groups) {
    const container = document.getElementById('dataContainer');

    if (!groups.length) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-inbox d-block"></i>
                <p class="mb-0">등록된 재고 기록이 없습니다.</p>
            </div>`;
        return;
    }

    container.innerHTML = groups.map((g, idx) => `
        <div class="group-card">
            <div class="group-header" onclick="toggleGroup(${idx})">
                <div class="group-title">
                    <i class="bi bi-geo-alt text-primary me-2"></i>
                    <code>${escapeHtml(g.location.barcode)}</code>
                    ${g.location.name ? '<span class="text-muted ms-2">' + escapeHtml(g.location.name) + '</span>' : ''}
                </div>
                <div class="group-badge">
                    <span class="badge bg-primary">${g.products.length}종</span>
                    <span class="badge bg-success ms-1">${g.total_quantity}개</span>
                    <i class="bi bi-chevron-down ms-2" id="groupIcon-${idx}"></i>
                </div>
            </div>
            <div class="group-body" id="groupBody-${idx}">
                <table class="table group-table">
                    <thead>
                        <tr>
                            <th class="ps-3">상품명</th>
                            <th>유통기한</th>
                            <th>로트번호</th>
                            <th class="text-center">수량</th>
                            <th>바코드</th>
                            <th>작업자</th>
                            <th>등록시간</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${g.products.map(p => `
                        <tr>
                            <td class="ps-3 product-name">${escapeHtml(p.product_name || '-')}</td>
                            <td>${escapeHtml(p.expiry_date || '-')}</td>
                            <td>${escapeHtml(p.lot_number || '-')}</td>
                            <td class="text-center fw-bold">${p.quantity}</td>
                            <td><code>${escapeHtml(p.barcode || '-')}</code></td>
                            <td>${escapeHtml(p.worker || '-')}</td>
                            <td class="small text-muted">${escapeHtml(p.created_at)}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `).join('');
}

function renderByProduct(groups) {
    const container = document.getElementById('dataContainer');

    if (!groups.length) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-inbox d-block"></i>
                <p class="mb-0">등록된 재고 기록이 없습니다.</p>
            </div>`;
        return;
    }

    container.innerHTML = groups.map((g, idx) => `
        <div class="group-card">
            <div class="group-header" onclick="toggleGroup(${idx})">
                <div class="group-title">
                    <i class="bi bi-box-seam text-success me-2"></i>
                    <code>${escapeHtml(g.barcode || '-')}</code>
                    ${g.product_name ? '<span class="text-muted ms-2">' + escapeHtml(g.product_name) + '</span>' : ''}
                </div>
                <div class="group-badge">
                    <span class="badge bg-info">${g.locations.length}곳</span>
                    <span class="badge bg-success ms-1">총 ${g.total_quantity}개</span>
                    <i class="bi bi-chevron-down ms-2" id="groupIcon-${idx}"></i>
                </div>
            </div>
            <div class="group-body" id="groupBody-${idx}">
                <table class="table group-table">
                    <thead>
                        <tr>
                            <th class="ps-3">로케이션</th>
                            <th>로케이션명</th>
                            <th>유통기한</th>
                            <th>로트번호</th>
                            <th class="text-center">수량</th>
                            <th>작업자</th>
                            <th>등록시간</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${g.locations.map(l => `
                        <tr>
                            <td class="ps-3"><code>${escapeHtml(l.location_barcode)}</code></td>
                            <td>${escapeHtml(l.location_name || '-')}</td>
                            <td>${escapeHtml(l.expiry_date || '-')}</td>
                            <td>${escapeHtml(l.lot_number || '-')}</td>
                            <td class="text-center fw-bold">${l.quantity}</td>
                            <td>${escapeHtml(l.worker || '-')}</td>
                            <td class="small text-muted">${escapeHtml(l.created_at)}</td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `).join('');
}

function toggleGroup(idx) {
    const body = document.getElementById(`groupBody-${idx}`);
    const icon = document.getElementById(`groupIcon-${idx}`);
    if (body.style.display === 'none') {
        body.style.display = 'block';
        icon.className = 'bi bi-chevron-down ms-2';
    } else {
        body.style.display = 'none';
        icon.className = 'bi bi-chevron-right ms-2';
    }
}

function updateStats(groups) {
    if (!groups) {
        document.getElementById('statLocations').textContent = '-';
        document.getElementById('statProducts').textContent = '-';
        document.getElementById('statQuantity').textContent = '-';
        return;
    }

    if (currentTab === 'location' || currentTab === 'treemap') {
        const locationCount = groups.length;
        let productCount = 0;
        let totalQty = 0;
        groups.forEach(g => {
            productCount += g.products.length;
            totalQty += g.total_quantity;
        });
        document.getElementById('statLocations').textContent = locationCount;
        document.getElementById('statProducts').textContent = productCount;
        document.getElementById('statQuantity').textContent = totalQty.toLocaleString();
    } else {
        let locationSet = new Set();
        const productCount = groups.length;
        let totalQty = 0;
        groups.forEach(g => {
            g.locations.forEach(l => locationSet.add(l.location_barcode));
            totalQty += g.total_quantity;
        });
        document.getElementById('statLocations').textContent = locationSet.size;
        document.getElementById('statProducts').textContent = productCount;
        document.getElementById('statQuantity').textContent = totalQty.toLocaleString();
    }
}

function exportExcel() {
    const sessionId = document.getElementById('sessionSelect').value;
    if (!sessionId) return;
    const search = document.getElementById('searchInput').value.trim();
    const params = new URLSearchParams({ session_id: sessionId });
    if (search) params.append('search', search);
    window.location.href = `{% url "inventory:export_records_excel" %}?${params.toString()}`;
}

// ============================================================================
// 트리맵 시각화
// ============================================================================

const ZONE_COLORS = d3.schemeTableau10;
let selectedCell = null;

/**
 * 로케이션 바코드 파싱
 * 형식: {센터}-{동}-{열}-{라인}-{층}  예) 1C-1D-A-01-02
 * 파싱 실패 시 null 반환
 */
function parseLocationBarcode(barcode) {
    if (!barcode) return null;
    const parts = barcode.split('-');
    if (parts.length < 5) return null;

    const center = parts[0];  // 1C
    const dong = parts[1];    // 1D
    const col = parts[2];     // A
    const line = parts[3];    // 01
    const floor = parts[4];   // 02

    // 최소 검증: 센터/동은 비어있으면 안됨
    if (!center || !dong || !col || !line || !floor) return null;

    return {
        center,
        dong,
        col,
        line,
        floor,
        building: `${center}-${dong}`,        // "1C-1D" (1단계)
        colLabel: `${col}열`,                   // "A열" (2단계)
        cellLabel: `${line}-${floor}`,          // "01-02" (셀 라벨)
        fullLabel: `${col}-${line}-${floor}`,   // "A-01-02" (간략 표기)
    };
}

function buildTreemapData(groups) {
    // 바코드 파싱 기반 3단 계층: 센터+동 → 열 → 로케이션
    const buildingMap = {};  // { "1C-1D": { "A": [...], "B": [...] } }
    const unmatched = [];    // 파싱 실패 로케이션

    groups.forEach(g => {
        const parsed = parseLocationBarcode(g.location.barcode);
        const locData = {
            name: g.location.barcode,
            locationName: g.location.name || '',
            locationId: g.location.id,
            value: g.total_quantity || 1,
            products: g.products,
            productCount: g.products.length,
            parsed: parsed,
        };

        if (!parsed) {
            locData.zone = '기타';
            unmatched.push(locData);
            return;
        }

        locData.zone = parsed.building;
        if (!buildingMap[parsed.building]) buildingMap[parsed.building] = {};
        if (!buildingMap[parsed.building][parsed.col]) buildingMap[parsed.building][parsed.col] = [];
        buildingMap[parsed.building][parsed.col].push(locData);
    });

    // 계층 구조 생성
    const children = [];

    // 센터+동 순서대로
    Object.keys(buildingMap).sort().forEach(building => {
        const colMap = buildingMap[building];
        const colChildren = Object.keys(colMap).sort().map(col => ({
            name: `${col}열`,
            children: colMap[col].sort((a, b) => a.name.localeCompare(b.name)),
        }));

        children.push({
            name: building,
            children: colChildren,
        });
    });

    // 파싱 실패 로케이션은 "기타"로 묶기
    if (unmatched.length > 0) {
        children.push({
            name: '기타',
            children: unmatched.sort((a, b) => a.name.localeCompare(b.name)),
        });
    }

    return { name: '전체', children };
}

function renderTreemap(groups) {
    const container = document.getElementById('dataContainer');

    if (!groups || !groups.length) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-inbox d-block"></i>
                <p class="mb-0">등록된 재고 기록이 없습니다.</p>
            </div>`;
        return;
    }

    const hierarchyData = buildTreemapData(groups);
    const zones = hierarchyData.children.map(c => c.name);
    const colorScale = d3.scaleOrdinal().domain(zones).range(ZONE_COLORS);

    // 레이아웃 생성
    container.innerHTML = `
        <div class="treemap-wrapper">
            <div class="treemap-legend" id="treemapLegend"></div>
            <div class="treemap-container" id="treemapChart"></div>
            <div id="treemapDetail"></div>
        </div>
        <div class="treemap-tooltip" id="treemapTooltip"></div>
    `;

    // 범례 렌더링 (센터+동 단위)
    const legendEl = document.getElementById('treemapLegend');
    legendEl.innerHTML = zones.map(z => {
        // "1C-1D" → "1센터 1동" 형태로 표시
        const parts = z.split('-');
        const label = (parts.length === 2)
            ? `${parts[0].replace('C', '센터')} ${parts[1].replace('D', '동')}`
            : z;
        return `
            <div class="treemap-legend-item">
                <div class="treemap-legend-swatch" style="background:${colorScale(z)}"></div>
                <span>${escapeHtml(label)} <code style="font-size:0.75rem;">${escapeHtml(z)}</code></span>
            </div>
        `;
    }).join('');

    // SVG 트리맵 렌더링
    const chartEl = document.getElementById('treemapChart');
    const width = chartEl.clientWidth;
    const height = chartEl.clientHeight;

    const root = d3.hierarchy(hierarchyData)
        .sum(d => d.value)
        .sort((a, b) => b.value - a.value);

    d3.treemap()
        .size([width, height])
        .paddingOuter(4)
        .paddingInner(2)
        .paddingTop(22)  // 센터+동 라벨용
        .round(true)(root);

    const svg = d3.select('#treemapChart')
        .append('svg')
        .attr('viewBox', `0 0 ${width} ${height}`)
        .attr('preserveAspectRatio', 'xMidYMid meet');

    const tooltip = document.getElementById('treemapTooltip');

    // 1단계: 센터+동 그룹 (가장 바깥 테두리 + 라벨)
    const buildingGroups = svg.selectAll('.building-group')
        .data(root.children || [])
        .join('g')
        .attr('class', 'building-group');

    buildingGroups.append('rect')
        .attr('x', d => d.x0)
        .attr('y', d => d.y0)
        .attr('width', d => d.x0 === d.x1 ? 0 : d.x1 - d.x0)
        .attr('height', d => d.y0 === d.y1 ? 0 : d.y1 - d.y0)
        .attr('fill', d => {
            const c = d3.color(colorScale(d.data.name));
            c.opacity = 0.08;
            return c.toString();
        })
        .attr('stroke', d => colorScale(d.data.name))
        .attr('stroke-width', 2)
        .attr('rx', 5);

    buildingGroups.append('text')
        .attr('x', d => d.x0 + 7)
        .attr('y', d => d.y0 + 15)
        .text(d => d.data.name)
        .attr('fill', d => d3.color(colorScale(d.data.name)).darker(0.8))
        .attr('font-size', '12px')
        .attr('font-weight', '800');

    // 2단계: 열 그룹 (depth=2 노드) — 작은 라벨만
    const colNodes = root.descendants().filter(d => d.depth === 2);
    const colGroups = svg.selectAll('.col-group')
        .data(colNodes)
        .join('g')
        .attr('class', 'col-group');

    colGroups.append('text')
        .attr('x', d => d.x0 + 4)
        .attr('y', d => d.y0 + 11)
        .text(d => d.data.name)
        .attr('fill', d => d3.color(colorScale(d.parent.data.name)).darker(0.3))
        .attr('font-size', '9px')
        .attr('font-weight', '600')
        .attr('opacity', d => (d.x1 - d.x0) > 30 ? 1 : 0);

    // 3단계: 로케이션 셀 (리프 노드)
    const leaves = root.leaves();

    // 리프의 최상위 그룹(센터+동) 찾기
    function getBuilding(d) {
        let node = d;
        while (node.depth > 1) node = node.parent;
        return node.data.name;
    }

    const cells = svg.selectAll('.treemap-cell')
        .data(leaves)
        .join('g')
        .attr('class', 'treemap-cell')
        .attr('transform', d => `translate(${d.x0},${d.y0})`);

    cells.append('rect')
        .attr('width', d => Math.max(0, d.x1 - d.x0))
        .attr('height', d => Math.max(0, d.y1 - d.y0))
        .attr('fill', d => colorScale(getBuilding(d)))
        .attr('stroke', '#fff')
        .attr('stroke-width', 1.5)
        .attr('rx', 3)
        .attr('opacity', 0.8);

    // 라벨: 파싱된 경우 간결한 라벨, 아니면 원본 바코드
    cells.each(function(d) {
        const cellW = d.x1 - d.x0;
        const cellH = d.y1 - d.y0;
        const g = d3.select(this);
        const label = d.data.parsed ? d.data.parsed.cellLabel : d.data.name;
        const shortLabel = label.length > 12 ? label.substring(0, 12) + '..' : label;

        if (cellW > 40 && cellH > 28) {
            g.append('text')
                .attr('x', cellW / 2)
                .attr('y', cellH / 2 - 5)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', cellW > 80 ? '12px' : '10px')
                .attr('font-weight', '700')
                .text(shortLabel);

            g.append('text')
                .attr('x', cellW / 2)
                .attr('y', cellH / 2 + 11)
                .attr('text-anchor', 'middle')
                .attr('fill', 'rgba(255,255,255,0.85)')
                .attr('font-size', cellW > 80 ? '11px' : '9px')
                .attr('font-weight', '600')
                .text(d.data.value.toLocaleString() + '개');
        } else if (cellW > 22 && cellH > 16) {
            g.append('text')
                .attr('x', cellW / 2)
                .attr('y', cellH / 2 + 4)
                .attr('text-anchor', 'middle')
                .attr('fill', '#fff')
                .attr('font-size', '9px')
                .attr('font-weight', '700')
                .text(d.data.value.toLocaleString());
        }
    });

    // 호버 툴팁
    cells.on('mousemove', function(event, d) {
        const productLines = (d.data.products || []).slice(0, 5).map(p =>
            `<div>${escapeHtml(p.product_name || p.barcode)} — ${p.quantity}개</div>`
        ).join('');
        const moreCount = (d.data.products || []).length - 5;
        const p = d.data.parsed;
        const locDetail = p
            ? `<div class="tt-zone">${p.center} ${p.dong} · ${p.col}열 ${p.line}라인 ${p.floor}층</div>`
            : '';

        tooltip.innerHTML = `
            <div class="tt-title">${escapeHtml(d.data.name)}</div>
            ${d.data.locationName ? `<div class="tt-zone">${escapeHtml(d.data.locationName)}</div>` : ''}
            ${locDetail}
            <div style="margin-top:4px;">총 <span class="tt-qty">${d.data.value.toLocaleString()}개</span> · ${d.data.productCount}종</div>
            ${productLines ? `<div class="tt-products">${productLines}${moreCount > 0 ? `<div class="text-muted">외 ${moreCount}건...</div>` : ''}</div>` : ''}
        `;
        tooltip.style.display = 'block';
        tooltip.style.left = (event.clientX + 14) + 'px';
        tooltip.style.top = (event.clientY - 10) + 'px';
    })
    .on('mouseleave', function() {
        tooltip.style.display = 'none';
    });

    // 클릭 → 상세 패널
    cells.on('click', function(event, d) {
        event.stopPropagation();
        // 선택 상태 토글
        svg.selectAll('.treemap-cell').classed('selected', false);
        d3.select(this).classed('selected', true);
        selectedCell = d.data;
        renderTreemapDetail(d.data);
    });

    // 빈 영역 클릭 → 상세 닫기
    svg.on('click', function() {
        svg.selectAll('.treemap-cell').classed('selected', false);
        selectedCell = null;
        document.getElementById('treemapDetail').innerHTML = '';
    });
}

function renderTreemapDetail(data) {
    const detailEl = document.getElementById('treemapDetail');
    if (!data || !data.products || !data.products.length) {
        detailEl.innerHTML = '';
        return;
    }

    const p = data.parsed;
    const locInfo = p
        ? `<span class="text-muted ms-2">${p.center} ${p.dong} · ${p.col}열 ${p.line}라인 ${p.floor}층</span>`
        : (data.locationName ? `<span class="text-muted ms-2">${escapeHtml(data.locationName)}</span>` : '');

    detailEl.innerHTML = `
        <div class="treemap-detail">
            <div class="treemap-detail-header">
                <div class="detail-title">
                    <i class="bi bi-geo-alt text-primary me-2"></i>
                    <code>${escapeHtml(data.name)}</code>
                    ${locInfo}
                </div>
                <div>
                    <span class="badge bg-primary">${data.productCount}종</span>
                    <span class="badge bg-success ms-1">${data.value.toLocaleString()}개</span>
                </div>
            </div>
            <table class="table group-table mb-0">
                <thead>
                    <tr>
                        <th class="ps-3">상품명</th>
                        <th>유통기한</th>
                        <th>로트번호</th>
                        <th class="text-center">수량</th>
                        <th>바코드</th>
                        <th>작업자</th>
                        <th>등록시간</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.products.map(p => `
                    <tr>
                        <td class="ps-3 product-name">${escapeHtml(p.product_name || '-')}</td>
                        <td>${escapeHtml(p.expiry_date || '-')}</td>
                        <td>${escapeHtml(p.lot_number || '-')}</td>
                        <td class="text-center fw-bold">${p.quantity}</td>
                        <td><code>${escapeHtml(p.barcode || '-')}</code></td>
                        <td>${escapeHtml(p.worker || '-')}</td>
                        <td class="small text-muted">${escapeHtml(p.created_at)}</td>
                    </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// 윈도우 리사이즈 시 트리맵 다시 렌더링
let resizeTimer = null;
window.addEventListener('resize', function() {
    if (currentTab !== 'treemap' || !treemapLocationData) return;
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => renderTreemap(treemapLocationData), 300);
});

// ============================================================================
// 유틸리티
// ============================================================================

function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>
{% endblock %}
