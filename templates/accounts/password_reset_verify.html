{% extends 'base_auth.html' %}
{% load static %}

{% block title %}인증번호 확인{% endblock %}

{% block extra_css %}
<style>
    .code-input-group {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin: 20px 0;
    }
    .code-input-group input {
        width: 48px;
        height: 56px;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 700;
        border: 2px solid #dee2e6;
        border-radius: 10px;
        transition: border-color 0.2s, box-shadow 0.2s;
        font-family: monospace;
    }
    .code-input-group input:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
        outline: none;
    }
    .timer-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    .timer-badge.active { background: #e8f5e9; color: #2e7d32; }
    .timer-badge.expired { background: #fce4ec; color: #c62828; }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-logo">
                <img src="{% static 'images/logo.png'%}">
            </div>
            <p class="auth-subtitle">인증번호 확인</p>
        </div>

        <form method="post" class="auth-form" id="verifyForm">
            {% csrf_token %}

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <div class="text-center mb-2" style="font-size:0.88rem; color:#64748b; line-height:1.6;">
                <strong>{{ email }}</strong> 으로<br>
                전송된 6자리 인증번호를 입력하세요.
            </div>

            <div class="text-center mb-3">
                <span class="timer-badge active" id="timerBadge">
                    <i class="bi bi-clock"></i>
                    <span id="timerText">{{ expiry_minutes }}:00</span>
                </span>
            </div>

            <!-- 숨겨진 실제 값 필드 -->
            <input type="hidden" name="code" id="codeHidden">

            <!-- 6자리 개별 입력 -->
            <div class="code-input-group">
                <input type="text" maxlength="1" class="code-digit" data-idx="0" inputmode="numeric" pattern="[0-9]" autofocus>
                <input type="text" maxlength="1" class="code-digit" data-idx="1" inputmode="numeric" pattern="[0-9]">
                <input type="text" maxlength="1" class="code-digit" data-idx="2" inputmode="numeric" pattern="[0-9]">
                <input type="text" maxlength="1" class="code-digit" data-idx="3" inputmode="numeric" pattern="[0-9]">
                <input type="text" maxlength="1" class="code-digit" data-idx="4" inputmode="numeric" pattern="[0-9]">
                <input type="text" maxlength="1" class="code-digit" data-idx="5" inputmode="numeric" pattern="[0-9]">
            </div>

            <div class="d-grid gap-2 mt-3">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="bi bi-check-lg me-2"></i>인증번호 확인
                </button>
            </div>
        </form>

        <div class="auth-footer">
            <p class="mb-2">
                인증번호를 받지 못하셨나요?
                <form method="post" action="{% url 'accounts:password_reset_resend' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-link p-0" style="font-size:inherit; vertical-align:baseline;">
                        재전송
                    </button>
                </form>
            </p>
            <p class="mb-0">
                <a href="{% url 'accounts:password_reset_request' %}">
                    <i class="bi bi-arrow-left me-1"></i>이메일 다시 입력
                </a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const digits = document.querySelectorAll('.code-digit');
    const hiddenInput = document.getElementById('codeHidden');
    const form = document.getElementById('verifyForm');

    function updateHidden() {
        let code = '';
        digits.forEach(d => code += d.value);
        hiddenInput.value = code;
    }

    digits.forEach((input, idx) => {
        // 숫자만 입력 허용
        input.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value && idx < digits.length - 1) {
                digits[idx + 1].focus();
            }
            updateHidden();

            // 6자리 모두 입력 시 자동 제출
            let code = '';
            digits.forEach(d => code += d.value);
            if (code.length === 6) {
                hiddenInput.value = code;
                form.submit();
            }
        });

        // 백스페이스 시 이전 칸으로
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && idx > 0) {
                digits[idx - 1].focus();
                digits[idx - 1].value = '';
                updateHidden();
            }
        });

        // 붙여넣기 지원
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pasted = (e.clipboardData.getData('text') || '').replace(/[^0-9]/g, '').slice(0, 6);
            if (pasted.length > 0) {
                for (let i = 0; i < pasted.length && i < digits.length; i++) {
                    digits[i].value = pasted[i];
                }
                updateHidden();
                if (pasted.length >= 6) {
                    form.submit();
                } else {
                    digits[Math.min(pasted.length, digits.length - 1)].focus();
                }
            }
        });
    });

    // 타이머
    let totalSeconds = {{ expiry_minutes }} * 60;
    const timerText = document.getElementById('timerText');
    const timerBadge = document.getElementById('timerBadge');

    const timer = setInterval(function() {
        totalSeconds--;
        if (totalSeconds <= 0) {
            clearInterval(timer);
            timerText.textContent = '만료됨';
            timerBadge.className = 'timer-badge expired';
            return;
        }
        const min = Math.floor(totalSeconds / 60);
        const sec = totalSeconds % 60;
        timerText.textContent = min + ':' + (sec < 10 ? '0' : '') + sec;

        if (totalSeconds <= 60) {
            timerBadge.className = 'timer-badge expired';
        }
    }, 1000);
})();
</script>
{% endblock %}
