{% extends 'base.html' %}
{% load humanize %}

{% block title %}단가 일괄 등록{% endblock %}
{% block page_title %}단가 일괄 등록{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-1">
            <i class="bi bi-table me-2"></i>단가 일괄 등록
        </h4>
        <p class="text-muted mb-0">거래처: {{ client.company_name }}</p>
    </div>
</div>

<form method="post" novalidate id="bulkForm">
    {% csrf_token %}

    {% if form.errors %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle me-2"></i>입력 내용을 확인해주세요.
        <ul class="mb-0 mt-2">
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- 적용 기간 -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-calendar-range me-2"></i>적용 기간</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="{{ form.valid_from.id_for_label }}" class="form-label">적용 시작일 <span class="text-danger">*</span></label>
                    {{ form.valid_from }}
                </div>
                <div class="col-md-4 mb-3">
                    <label for="{{ form.valid_to.id_for_label }}" class="form-label">적용 종료일 <span class="text-danger">*</span></label>
                    {{ form.valid_to }}
                </div>
            </div>
        </div>
    </div>

    <!-- 단가 테이블 -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h6 class="mb-0"><i class="bi bi-currency-dollar me-2"></i>단가 항목</h6>
                <small class="text-muted">행을 추가하여 작업유형별 단가를 입력하세요.</small>
            </div>
            <button type="button" class="btn btn-sm btn-primary" id="addRowBtn">
                <i class="bi bi-plus-lg me-1"></i>행 추가
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0" id="priceTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 18%;">작업 유형</th>
                            <th style="width: 12%;">소분류</th>
                            <th style="width: 12%;">품목</th>
                            <th style="width: 12%;">단가 (원)</th>
                            <th style="width: 8%;">단위</th>
                            <th style="width: 8%;">수량</th>
                            <th style="width: 18%;">비고</th>
                            <th style="width: 5%;"></th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody">
                        <!-- 동적으로 행이 추가됩니다 -->
                    </tbody>
                </table>
            </div>
            <div class="text-center py-3" id="emptyMessage">
                <span class="text-muted"><i class="bi bi-info-circle me-1"></i>위의 "행 추가" 버튼을 클릭하여 단가 항목을 추가하세요.</span>
            </div>
        </div>
    </div>

    <!-- 메모 -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-chat-text me-2"></i>메모</h6>
        </div>
        <div class="card-body">
            {{ form.memo }}
        </div>
    </div>

    <input type="hidden" name="row_count" id="rowCount" value="0">

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i>일괄 저장
        </button>
        <a href="{% url 'clients:client_detail' client.pk %}" class="btn btn-outline-secondary">
            <i class="bi bi-x-lg me-1"></i>취소
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const workTypeGroups = {{ work_type_groups_json|safe }};
    let rowIndex = 0;
    const tbody = document.getElementById('priceTableBody');
    const rowCountInput = document.getElementById('rowCount');
    const emptyMsg = document.getElementById('emptyMessage');

    // 작업유형 select의 optgroup HTML 생성
    function buildWorkTypeOptions() {
        let html = '<option value="">---</option>';
        workTypeGroups.forEach(group => {
            html += `<optgroup label="${group.name}">`;
            group.items.forEach(item => {
                html += `<option value="${item.value}">${item.label}</option>`;
            });
            html += '</optgroup>';
        });
        return html;
    }

    const workTypeOptionsHTML = buildWorkTypeOptions();

    function addRow(data) {
        const idx = rowIndex++;
        const tr = document.createElement('tr');
        tr.dataset.rowIndex = idx;
        tr.innerHTML = `
            <td>
                <select name="row_${idx}_work_type" class="form-select form-select-sm">
                    ${workTypeOptionsHTML}
                </select>
            </td>
            <td><input type="text" name="row_${idx}_sub_category" class="form-control form-control-sm" placeholder="소분류" value="${data?.sub_category || ''}"></td>
            <td><input type="text" name="row_${idx}_item_name" class="form-control form-control-sm" placeholder="품목" value="${data?.item_name || ''}"></td>
            <td><input type="number" name="row_${idx}_unit_price" class="form-control form-control-sm" placeholder="0" step="1" min="0" value="${data?.unit_price || ''}"></td>
            <td><input type="text" name="row_${idx}_unit" class="form-control form-control-sm" placeholder="건" style="width:80px;" value="${data?.unit || ''}"></td>
            <td><input type="number" name="row_${idx}_quantity" class="form-control form-control-sm" placeholder="1" min="0" style="width:70px;" value="${data?.quantity || ''}"></td>
            <td><input type="text" name="row_${idx}_remarks" class="form-control form-control-sm" placeholder="비고" value="${data?.remarks || ''}"></td>
            <td class="text-center align-middle">
                <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" title="삭제">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;

        // 작업유형 값 설정
        if (data?.work_type) {
            tr.querySelector('select').value = data.work_type;
        }

        tbody.appendChild(tr);
        updateRowCount();
        emptyMsg.style.display = 'none';
    }

    function updateRowCount() {
        rowCountInput.value = rowIndex;
    }

    // 행 추가 버튼
    document.getElementById('addRowBtn').addEventListener('click', () => addRow());

    // 행 삭제 (이벤트 위임)
    tbody.addEventListener('click', (e) => {
        const btn = e.target.closest('.remove-row-btn');
        if (btn) {
            btn.closest('tr').remove();
            if (tbody.children.length === 0) {
                emptyMsg.style.display = 'block';
            }
        }
    });

    // 폼 제출 시 행 인덱스 재정렬
    document.getElementById('bulkForm').addEventListener('submit', (e) => {
        const rows = tbody.querySelectorAll('tr');
        rowCountInput.value = rows.length;

        rows.forEach((tr, newIdx) => {
            const oldIdx = tr.dataset.rowIndex;
            if (String(oldIdx) !== String(newIdx)) {
                // 모든 input/select의 name을 재정렬
                tr.querySelectorAll('input, select').forEach(el => {
                    if (el.name) {
                        el.name = el.name.replace(`row_${oldIdx}_`, `row_${newIdx}_`);
                    }
                });
                tr.dataset.rowIndex = newIdx;
            }
        });
    });

    // 초기 행 5개 추가
    for (let i = 0; i < 5; i++) {
        addRow();
    }
})();
</script>
{% endblock %}
