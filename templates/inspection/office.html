{% extends 'base.html' %}
{% load static %}

{% block title %}송장 데이터 업로드{% endblock %}
{% block page_title %}송장 데이터 업로드{% endblock %}

{% block extra_css %}
<style>
    .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafbfc;
    }
    .upload-zone:hover,
    .upload-zone.drag-over {
        border-color: #0d6efd;
        background: #f0f6ff;
    }
    .upload-zone i {
        font-size: 3rem;
        color: #adb5bd;
    }
    .upload-zone.drag-over i {
        color: #0d6efd;
    }
    .upload-result {
        display: none;
    }
    .upload-result.show {
        display: block;
    }
    /* 다중 파일 목록 */
    .file-list {
        max-height: 200px;
        overflow-y: auto;
    }
    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        background: #f8f9fa;
        font-size: 0.88rem;
    }
    .file-item .file-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 0;
    }
    .file-item .file-info span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .file-item .file-status {
        flex-shrink: 0;
        font-size: 0.78rem;
    }
    .file-item.uploading { background: #e7f1ff; }
    .file-item.done { background: #d4edda; }
    .file-item.error { background: #f8d7da; }
    .stat-card {
        border-radius: 10px;
        padding: 1.25rem;
        text-align: center;
    }
    .stat-card .stat-number {
        font-size: 2rem;
        font-weight: 700;
    }
    .stat-card .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .progress-bar-upload {
        height: 6px;
        border-radius: 3px;
        display: none;
    }
    .progress-bar-upload.show {
        display: flex;
    }
    .batch-table th {
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
    }
    .batch-table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }
    .badge-status {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }
    .progress-mini {
        height: 6px;
        border-radius: 3px;
        min-width: 80px;
    }
    .batch-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .batch-meta i {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- 현황 카드 -->
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-primary" id="statTotal">{{ total }}</div>
            <div class="stat-label">전체 송장</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-secondary" id="statWaiting">{{ waiting }}</div>
            <div class="stat-label">대기중</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-warning" id="statInspecting">{{ inspecting }}</div>
            <div class="stat-label">검수중</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-success" id="statCompleted">{{ completed }}</div>
            <div class="stat-label">완료</div>
        </div>
    </div>

    <!-- 엑셀 업로드 -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0"><i class="bi bi-upload me-2"></i>엑셀 파일 업로드</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-zone" id="uploadZone">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                        <p class="mt-3 mb-1 fw-semibold">파일을 드래그하거나 클릭하여 선택</p>
                        <p class="text-muted small mb-0">엑셀 파일 (.xlsx, .xls) 지원 | 여러 파일 동시 선택 가능</p>
                        <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" class="d-none" multiple>
                    </div>
                    <div id="selectedFiles" class="mt-3 d-none">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <small class="text-muted fw-semibold" id="fileCountLabel">0개 파일 선택</small>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="clearFiles">
                                <i class="bi bi-x-lg me-1"></i>전체 취소
                            </button>
                        </div>
                        <div class="d-flex flex-column gap-1 file-list" id="fileList"></div>
                    </div>
                    <div class="progress progress-bar-upload mt-3" id="progressBar">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3" id="uploadBtn" disabled>
                        <i class="bi bi-cloud-upload me-1"></i>업로드하기
                    </button>
                </form>

                <!-- 업로드 결과 -->
                <div class="upload-result mt-4" id="uploadResult">
                    <div id="uploadAlerts"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 업로드 이력 -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0"><i class="bi bi-clock-history me-2"></i>업로드 이력</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 batch-table">
                        <thead class="table-light">
                            <tr>
                                <th>파일명</th>
                                <th>출력차수</th>
                                <th>배송메모</th>
                                <th class="text-center">송장</th>
                                <th class="text-center">상품</th>
                                <th>진행률</th>
                                <th>업로드자</th>
                                <th>업로드 시간</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="batchesBody">
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">데이터를 불러오는 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- 페이지네이션 -->
                <div class="d-flex justify-content-between align-items-center px-3 py-2 border-top" id="paginationArea" style="display:none!important;">
                    <small class="text-muted" id="pageInfo"></small>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const selectedFiles = document.getElementById('selectedFiles');
    const clearFiles = document.getElementById('clearFiles');
    const fileList = document.getElementById('fileList');
    const fileCountLabel = document.getElementById('fileCountLabel');
    const progressBar = document.getElementById('progressBar');
    const uploadResult = document.getElementById('uploadResult');
    const uploadAlerts = document.getElementById('uploadAlerts');

    let pendingFiles = [];  // 업로드 대기 파일 목록

    // 드래그 앤 드롭
    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
    });
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) addFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) addFiles(e.target.files);
        fileInput.value = '';  // 같은 파일 재선택 허용
    });

    clearFiles.addEventListener('click', () => {
        pendingFiles = [];
        renderFileList();
    });

    function addFiles(fileListObj) {
        for (let i = 0; i < fileListObj.length; i++) {
            const file = fileListObj[i];
            if (!file.name.match(/\.(xlsx|xls)$/i)) continue;
            // 중복 파일명 방지
            if (pendingFiles.some(f => f.name === file.name && f.size === file.size)) continue;
            pendingFiles.push(file);
        }
        renderFileList();
    }

    function removeFileAt(index) {
        pendingFiles.splice(index, 1);
        renderFileList();
    }

    function renderFileList() {
        if (pendingFiles.length === 0) {
            selectedFiles.classList.add('d-none');
            uploadBtn.disabled = true;
            return;
        }

        selectedFiles.classList.remove('d-none');
        uploadBtn.disabled = false;
        fileCountLabel.textContent = `${pendingFiles.length}개 파일 선택`;

        fileList.innerHTML = pendingFiles.map((file, idx) => {
            const sizeKB = (file.size / 1024).toFixed(1);
            return `<div class="file-item" data-index="${idx}" id="fileItem${idx}">
                <div class="file-info">
                    <i class="bi bi-file-earmark-excel text-success"></i>
                    <span>${escapeHtml(file.name)}</span>
                    <small class="text-muted">(${sizeKB} KB)</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="file-status" id="fileStatus${idx}"></span>
                    <button type="button" class="btn btn-sm btn-outline-secondary border-0 p-0 px-1"
                            onclick="removeFileAt(${idx})" title="제거">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    window.removeFileAt = removeFileAt;

    // 다중 파일 순차 업로드
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (pendingFiles.length === 0) return;

        const filesToUpload = [...pendingFiles];
        const totalCount = filesToUpload.length;

        uploadBtn.disabled = true;
        uploadAlerts.innerHTML = '';
        uploadResult.classList.remove('show');
        progressBar.classList.add('show');

        let successCount = 0;
        let failCount = 0;
        let alertsHtml = '';

        for (let i = 0; i < filesToUpload.length; i++) {
            const file = filesToUpload[i];
            const pct = Math.round(((i) / totalCount) * 100);
            progressBar.querySelector('.progress-bar').style.width = `${pct}%`;
            uploadBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${i + 1}/${totalCount} 업로드 중...`;

            // 파일 아이템 상태 업데이트
            const fileItem = document.getElementById(`fileItem${i}`);
            const fileStatus = document.getElementById(`fileStatus${i}`);
            if (fileItem) fileItem.classList.add('uploading');
            if (fileStatus) fileStatus.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('{% url "inspection:upload_excel" %}', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();

                if (result.success) {
                    successCount++;
                    if (fileItem) { fileItem.classList.remove('uploading'); fileItem.classList.add('done'); }
                    if (fileStatus) fileStatus.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>';
                    alertsHtml += `<div class="alert alert-success py-2 mb-1">
                        <i class="bi bi-check-circle me-1"></i>
                        <strong>${escapeHtml(file.name)}</strong> - ${result.message}
                        <small class="d-block">송장 ${result.total_orders}건, 상품 ${result.total_products}건</small>
                    </div>`;
                } else {
                    failCount++;
                    if (fileItem) { fileItem.classList.remove('uploading'); fileItem.classList.add('error'); }
                    if (fileStatus) fileStatus.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>';
                    alertsHtml += `<div class="alert alert-danger py-2 mb-1">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        <strong>${escapeHtml(file.name)}</strong> - ${result.message}
                    </div>`;
                }
            } catch (error) {
                failCount++;
                if (fileItem) { fileItem.classList.remove('uploading'); fileItem.classList.add('error'); }
                if (fileStatus) fileStatus.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>';
                alertsHtml += `<div class="alert alert-danger py-2 mb-1">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    <strong>${escapeHtml(file.name)}</strong> - 네트워크 오류
                </div>`;
            }
        }

        progressBar.querySelector('.progress-bar').style.width = '100%';

        // 전체 요약
        let summaryClass = failCount === 0 ? 'alert-success' : successCount === 0 ? 'alert-danger' : 'alert-warning';
        alertsHtml = `<div class="alert ${summaryClass} mb-2">
            <strong>총 ${totalCount}개 파일</strong> | 성공 ${successCount}건 | 실패 ${failCount}건
        </div>` + alertsHtml;

        uploadAlerts.innerHTML = alertsHtml;
        uploadResult.classList.add('show');
        loadBatches(1);

        setTimeout(() => {
            progressBar.classList.remove('show');
            progressBar.querySelector('.progress-bar').style.width = '0%';
        }, 1000);

        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-1"></i>업로드하기';
        pendingFiles = [];
        renderFileList();
    });

    let currentPage = 1;
    const PAGE_SIZE = 10;

    // 업로드 이력 로드
    async function loadBatches(page) {
        if (page) currentPage = page;
        try {
            const params = new URLSearchParams({ page: currentPage, page_size: PAGE_SIZE });
            const response = await fetch(`{% url "inspection:get_upload_batches" %}?${params.toString()}`);
            const result = await response.json();
            const tbody = document.getElementById('batchesBody');

            if (!result.batches || result.batches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">업로드 이력이 없습니다.</td></tr>';
                updateStats(0, 0, 0, 0);
                document.getElementById('paginationArea').style.display = 'none';
                return;
            }

            // 현황 카드 갱신
            let totalAll = 0, waitAll = 0, inspAll = 0, compAll = 0;
            result.batches.forEach(b => {
                totalAll += b.total_orders;
                waitAll += b.waiting;
                inspAll += b.inspecting;
                compAll += b.completed;
            });
            updateStats(totalAll, waitAll, inspAll, compAll);

            tbody.innerHTML = result.batches.map(b => {
                const total = b.total_orders;
                const pct = total > 0 ? Math.round((b.completed / total) * 100) : 0;
                const uploaded = new Date(b.uploaded_at);
                const dateStr = uploaded.toLocaleDateString('ko-KR');
                const timeStr = uploaded.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                let barClass = 'bg-primary';
                if (pct === 100) barClass = 'bg-success';
                else if (pct > 0) barClass = 'bg-warning';

                return `<tr>
                    <td>
                        <i class="bi bi-file-earmark-excel text-success me-1"></i>
                        <span class="fw-medium">${escapeHtml(b.file_name)}</span>
                    </td>
                    <td>${escapeHtml(b.print_order) || '<span class="text-muted">-</span>'}</td>
                    <td>${escapeHtml(b.delivery_memo) || '<span class="text-muted">-</span>'}</td>
                    <td class="text-center">${b.total_orders}</td>
                    <td class="text-center">${b.total_products}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress progress-mini flex-grow-1">
                                <div class="progress-bar ${barClass}" style="width: ${pct}%"></div>
                            </div>
                            <small class="text-nowrap">${b.completed}/${total}</small>
                        </div>
                    </td>
                    <td>${escapeHtml(b.uploaded_by) || '-'}</td>
                    <td>
                        <span class="batch-meta">${dateStr} ${timeStr}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBatch(${b.id}, '${escapeHtml(b.file_name)}')" title="삭제">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');

            renderPagination(result);
        } catch (error) {
            console.error('업로드 이력 로드 실패:', error);
        }
    }

    function renderPagination(data) {
        const area = document.getElementById('paginationArea');
        const pageInfo = document.getElementById('pageInfo');
        const pagination = document.getElementById('pagination');

        if (data.total_pages <= 1) {
            area.style.display = 'none';
            return;
        }

        area.style.display = '';
        area.style.cssText = '';
        pageInfo.textContent = `총 ${data.total}건 (${data.page} / ${data.total_pages} 페이지)`;

        let html = `<li class="page-item ${!data.has_previous ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" onclick="window.goPage(${data.page - 1})"><i class="bi bi-chevron-left"></i></a></li>`;

        const startPage = Math.max(1, data.page - 2);
        const endPage = Math.min(data.total_pages, data.page + 2);
        for (let i = startPage; i <= endPage; i++) {
            html += `<li class="page-item ${i === data.page ? 'active' : ''}">
                <a class="page-link" href="javascript:void(0)" onclick="window.goPage(${i})">${i}</a></li>`;
        }

        html += `<li class="page-item ${!data.has_next ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" onclick="window.goPage(${data.page + 1})"><i class="bi bi-chevron-right"></i></a></li>`;

        pagination.innerHTML = html;
    }

    window.goPage = function(page) { loadBatches(page); };

    function updateStats(total, waiting, inspecting, completed) {
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statWaiting').textContent = waiting;
        document.getElementById('statInspecting').textContent = inspecting;
        document.getElementById('statCompleted').textContent = completed;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 배치 삭제
    window.deleteBatch = async function(batchId, fileName) {
        if (!confirm(`"${fileName}" 업로드 데이터를 삭제하시겠습니까?\n해당 파일의 모든 송장과 상품이 삭제됩니다.`)) {
            return;
        }
        try {
            const response = await fetch(`/inspection/api/batches/${batchId}/delete/`, {
                method: 'POST',
            });
            const result = await response.json();
            if (result.success) {
                loadBatches();
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('삭제 중 오류가 발생했습니다.');
        }
    };

    // 초기 로드
    loadBatches(1);
});
</script>
{% endblock %}
