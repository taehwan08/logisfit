{% extends 'base.html' %}
{% load static %}

{% block title %}송장 데이터 업로드{% endblock %}
{% block page_title %}송장 데이터 업로드{% endblock %}

{% block extra_css %}
<style>
    .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafbfc;
    }
    .upload-zone:hover,
    .upload-zone.drag-over {
        border-color: #0d6efd;
        background: #f0f6ff;
    }
    .upload-zone i {
        font-size: 3rem;
        color: #adb5bd;
    }
    .upload-zone.drag-over i {
        color: #0d6efd;
    }
    .upload-result {
        display: none;
    }
    .upload-result.show {
        display: block;
    }
    .stat-card {
        border-radius: 10px;
        padding: 1.25rem;
        text-align: center;
    }
    .stat-card .stat-number {
        font-size: 2rem;
        font-weight: 700;
    }
    .stat-card .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .progress-bar-upload {
        height: 6px;
        border-radius: 3px;
        display: none;
    }
    .progress-bar-upload.show {
        display: flex;
    }
    .batch-table th {
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
    }
    .batch-table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }
    .badge-status {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }
    .progress-mini {
        height: 6px;
        border-radius: 3px;
        min-width: 80px;
    }
    .batch-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .batch-meta i {
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- 현황 카드 -->
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-primary" id="statTotal">{{ total }}</div>
            <div class="stat-label">전체 송장</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-secondary" id="statWaiting">{{ waiting }}</div>
            <div class="stat-label">대기중</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-warning" id="statInspecting">{{ inspecting }}</div>
            <div class="stat-label">검수중</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-success" id="statCompleted">{{ completed }}</div>
            <div class="stat-label">완료</div>
        </div>
    </div>

    <!-- 엑셀 업로드 -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0"><i class="bi bi-upload me-2"></i>엑셀 파일 업로드</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-zone" id="uploadZone">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                        <p class="mt-3 mb-1 fw-semibold">파일을 드래그하거나 클릭하여 선택</p>
                        <p class="text-muted small mb-0">엑셀 파일 (.xlsx, .xls) 지원</p>
                        <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" class="d-none">
                    </div>
                    <div id="selectedFile" class="mt-3 d-none">
                        <div class="d-flex align-items-center justify-content-between bg-light rounded p-3">
                            <div>
                                <i class="bi bi-file-earmark-excel text-success me-2"></i>
                                <span id="fileName"></span>
                                <small class="text-muted ms-2" id="fileSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="removeFile">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="progress progress-bar-upload mt-3" id="progressBar">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3" id="uploadBtn" disabled>
                        <i class="bi bi-cloud-upload me-1"></i>업로드하기
                    </button>
                </form>

                <!-- 업로드 결과 -->
                <div class="upload-result mt-4" id="uploadResult">
                    <div class="alert" id="uploadAlert"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 업로드 이력 -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0"><i class="bi bi-clock-history me-2"></i>업로드 이력</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 batch-table">
                        <thead class="table-light">
                            <tr>
                                <th>파일명</th>
                                <th>출력차수</th>
                                <th>배송메모</th>
                                <th class="text-center">송장</th>
                                <th class="text-center">상품</th>
                                <th>진행률</th>
                                <th>업로드자</th>
                                <th>업로드 시간</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="batchesBody">
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">데이터를 불러오는 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const selectedFile = document.getElementById('selectedFile');
    const removeFile = document.getElementById('removeFile');
    const progressBar = document.getElementById('progressBar');
    const uploadResult = document.getElementById('uploadResult');
    const uploadAlert = document.getElementById('uploadAlert');

    // 드래그 앤 드롭
    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
    });
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            showSelectedFile(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showSelectedFile(e.target.files[0]);
        }
    });

    removeFile.addEventListener('click', () => {
        fileInput.value = '';
        selectedFile.classList.add('d-none');
        uploadBtn.disabled = true;
    });

    function showSelectedFile(file) {
        document.getElementById('fileName').textContent = file.name;
        const sizeKB = (file.size / 1024).toFixed(1);
        document.getElementById('fileSize').textContent = `(${sizeKB} KB)`;
        selectedFile.classList.remove('d-none');
        uploadBtn.disabled = false;
    }

    // 업로드
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!fileInput.files.length) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>업로드 중...';
        progressBar.classList.add('show');
        progressBar.querySelector('.progress-bar').style.width = '50%';

        try {
            const response = await fetch('{% url "inspection:upload_excel" %}', {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();

            progressBar.querySelector('.progress-bar').style.width = '100%';

            if (result.success) {
                uploadAlert.className = 'alert alert-success';
                uploadAlert.innerHTML = `<i class="bi bi-check-circle me-2"></i>${result.message}<br>` +
                    `<small>송장 ${result.total_orders}건, 상품 ${result.total_products}건 등록</small>`;
            } else {
                uploadAlert.className = 'alert alert-danger';
                uploadAlert.innerHTML = `<i class="bi bi-exclamation-circle me-2"></i>${result.message}`;
            }

            uploadResult.classList.add('show');
            loadBatches();
        } catch (error) {
            uploadAlert.className = 'alert alert-danger';
            uploadAlert.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>네트워크 오류가 발생했습니다.';
            uploadResult.classList.add('show');
        } finally {
            setTimeout(() => {
                progressBar.classList.remove('show');
                progressBar.querySelector('.progress-bar').style.width = '0%';
            }, 1000);
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-1"></i>업로드하기';
            fileInput.value = '';
            selectedFile.classList.add('d-none');
        }
    });

    // 업로드 이력 로드
    async function loadBatches() {
        try {
            const response = await fetch('{% url "inspection:get_upload_batches" %}');
            const result = await response.json();
            const tbody = document.getElementById('batchesBody');

            if (!result.batches || result.batches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">업로드 이력이 없습니다.</td></tr>';
                updateStats(0, 0, 0, 0);
                return;
            }

            // 현황 카드 갱신
            let totalAll = 0, waitAll = 0, inspAll = 0, compAll = 0;
            result.batches.forEach(b => {
                totalAll += b.total_orders;
                waitAll += b.waiting;
                inspAll += b.inspecting;
                compAll += b.completed;
            });
            updateStats(totalAll, waitAll, inspAll, compAll);

            tbody.innerHTML = result.batches.map(b => {
                const total = b.total_orders;
                const pct = total > 0 ? Math.round((b.completed / total) * 100) : 0;
                const uploaded = new Date(b.uploaded_at);
                const dateStr = uploaded.toLocaleDateString('ko-KR');
                const timeStr = uploaded.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

                let barClass = 'bg-primary';
                if (pct === 100) barClass = 'bg-success';
                else if (pct > 0) barClass = 'bg-warning';

                return `<tr>
                    <td>
                        <i class="bi bi-file-earmark-excel text-success me-1"></i>
                        <span class="fw-medium">${escapeHtml(b.file_name)}</span>
                    </td>
                    <td>${escapeHtml(b.print_order) || '<span class="text-muted">-</span>'}</td>
                    <td>${escapeHtml(b.delivery_memo) || '<span class="text-muted">-</span>'}</td>
                    <td class="text-center">${b.total_orders}</td>
                    <td class="text-center">${b.total_products}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress progress-mini flex-grow-1">
                                <div class="progress-bar ${barClass}" style="width: ${pct}%"></div>
                            </div>
                            <small class="text-nowrap">${b.completed}/${total}</small>
                        </div>
                    </td>
                    <td>${escapeHtml(b.uploaded_by) || '-'}</td>
                    <td>
                        <span class="batch-meta">${dateStr} ${timeStr}</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBatch(${b.id}, '${escapeHtml(b.file_name)}')" title="삭제">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        } catch (error) {
            console.error('업로드 이력 로드 실패:', error);
        }
    }

    function updateStats(total, waiting, inspecting, completed) {
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statWaiting').textContent = waiting;
        document.getElementById('statInspecting').textContent = inspecting;
        document.getElementById('statCompleted').textContent = completed;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 배치 삭제
    window.deleteBatch = async function(batchId, fileName) {
        if (!confirm(`"${fileName}" 업로드 데이터를 삭제하시겠습니까?\n해당 파일의 모든 송장과 상품이 삭제됩니다.`)) {
            return;
        }
        try {
            const response = await fetch(`/inspection/api/batches/${batchId}/delete/`, {
                method: 'POST',
            });
            const result = await response.json();
            if (result.success) {
                loadBatches();
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('삭제 중 오류가 발생했습니다.');
        }
    };

    // 초기 로드
    loadBatches();
});
</script>
{% endblock %}
