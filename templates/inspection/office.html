{% extends 'base.html' %}
{% load static %}

{% block title %}송장 데이터 업로드{% endblock %}
{% block page_title %}송장 데이터 업로드{% endblock %}

{% block extra_css %}
<style>
    .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fafbfc;
    }
    .upload-zone:hover,
    .upload-zone.drag-over {
        border-color: #0d6efd;
        background: #f0f6ff;
    }
    .upload-zone i {
        font-size: 3rem;
        color: #adb5bd;
    }
    .upload-zone.drag-over i {
        color: #0d6efd;
    }
    .upload-result {
        display: none;
    }
    .upload-result.show {
        display: block;
    }
    .stat-card {
        border-radius: 10px;
        padding: 1.25rem;
        text-align: center;
    }
    .stat-card .stat-number {
        font-size: 2rem;
        font-weight: 700;
    }
    .stat-card .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    .progress-bar-upload {
        height: 6px;
        border-radius: 3px;
        display: none;
    }
    .progress-bar-upload.show {
        display: flex;
    }
    .orders-table th {
        font-size: 0.85rem;
        font-weight: 600;
        white-space: nowrap;
    }
    .orders-table td {
        font-size: 0.85rem;
        vertical-align: middle;
    }
    .badge-status {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }
</style>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- 현황 카드 -->
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-primary" id="statTotal">{{ total }}</div>
            <div class="stat-label">전체 송장</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-secondary" id="statWaiting">{{ waiting }}</div>
            <div class="stat-label">대기중</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-warning" id="statInspecting">{{ inspecting }}</div>
            <div class="stat-label">검수중</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card bg-white shadow-sm">
            <div class="stat-number text-success" id="statCompleted">{{ completed }}</div>
            <div class="stat-label">완료</div>
        </div>
    </div>

    <!-- 엑셀 업로드 -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0"><i class="bi bi-upload me-2"></i>엑셀 파일 업로드</h5>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="upload-zone" id="uploadZone">
                        <i class="bi bi-file-earmark-spreadsheet"></i>
                        <p class="mt-3 mb-1 fw-semibold">파일을 드래그하거나 클릭하여 선택</p>
                        <p class="text-muted small mb-0">엑셀 파일 (.xlsx, .xls) 지원</p>
                        <input type="file" id="fileInput" name="file" accept=".xlsx,.xls" class="d-none">
                    </div>
                    <div id="selectedFile" class="mt-3 d-none">
                        <div class="d-flex align-items-center justify-content-between bg-light rounded p-3">
                            <div>
                                <i class="bi bi-file-earmark-excel text-success me-2"></i>
                                <span id="fileName"></span>
                                <small class="text-muted ms-2" id="fileSize"></small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="removeFile">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    <div class="progress progress-bar-upload mt-3" id="progressBar">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3" id="uploadBtn" disabled>
                        <i class="bi bi-cloud-upload me-1"></i>업로드하기
                    </button>
                </form>

                <!-- 업로드 결과 -->
                <div class="upload-result mt-4" id="uploadResult">
                    <div class="alert" id="uploadAlert"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 송장 목록 -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0"><i class="bi bi-list-ul me-2"></i>송장 목록</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
                        <option value="">전체 상태</option>
                        <option value="대기중">대기중</option>
                        <option value="검수중">검수중</option>
                        <option value="완료">완료</option>
                    </select>
                    <div class="input-group input-group-sm" style="width: 200px;">
                        <input type="text" class="form-control" placeholder="송장번호 검색" id="searchInput">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 orders-table">
                        <thead class="table-light">
                            <tr>
                                <th>송장번호</th>
                                <th>판매처</th>
                                <th>수령인</th>
                                <th>상품수</th>
                                <th>상태</th>
                                <th>업로드</th>
                                <th>완료</th>
                            </tr>
                        </thead>
                        <tbody id="ordersBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">데이터를 불러오는 중...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const selectedFile = document.getElementById('selectedFile');
    const removeFile = document.getElementById('removeFile');
    const progressBar = document.getElementById('progressBar');
    const uploadResult = document.getElementById('uploadResult');
    const uploadAlert = document.getElementById('uploadAlert');

    // 드래그 앤 드롭
    uploadZone.addEventListener('click', () => fileInput.click());

    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('drag-over');
    });
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            showSelectedFile(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showSelectedFile(e.target.files[0]);
        }
    });

    removeFile.addEventListener('click', () => {
        fileInput.value = '';
        selectedFile.classList.add('d-none');
        uploadBtn.disabled = true;
    });

    function showSelectedFile(file) {
        document.getElementById('fileName').textContent = file.name;
        const sizeKB = (file.size / 1024).toFixed(1);
        document.getElementById('fileSize').textContent = `(${sizeKB} KB)`;
        selectedFile.classList.remove('d-none');
        uploadBtn.disabled = false;
    }

    // 업로드
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!fileInput.files.length) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>업로드 중...';
        progressBar.classList.add('show');
        progressBar.querySelector('.progress-bar').style.width = '50%';

        try {
            const response = await fetch('{% url "inspection:upload_excel" %}', {
                method: 'POST',
                body: formData,
            });
            const result = await response.json();

            progressBar.querySelector('.progress-bar').style.width = '100%';

            if (result.success) {
                uploadAlert.className = 'alert alert-success';
                uploadAlert.innerHTML = `<i class="bi bi-check-circle me-2"></i>${result.message}<br>` +
                    `<small>송장 ${result.total_orders}건, 상품 ${result.total_products}건 등록</small>`;
            } else {
                uploadAlert.className = 'alert alert-danger';
                uploadAlert.innerHTML = `<i class="bi bi-exclamation-circle me-2"></i>${result.message}`;
            }

            uploadResult.classList.add('show');
            loadOrders();
            loadStats();
        } catch (error) {
            uploadAlert.className = 'alert alert-danger';
            uploadAlert.innerHTML = '<i class="bi bi-exclamation-circle me-2"></i>네트워크 오류가 발생했습니다.';
            uploadResult.classList.add('show');
        } finally {
            setTimeout(() => {
                progressBar.classList.remove('show');
                progressBar.querySelector('.progress-bar').style.width = '0%';
            }, 1000);
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-cloud-upload me-1"></i>업로드하기';
            fileInput.value = '';
            selectedFile.classList.add('d-none');
        }
    });

    // 송장 목록 로드
    async function loadOrders() {
        const status = document.getElementById('statusFilter').value;
        const search = document.getElementById('searchInput').value;
        let url = '{% url "inspection:get_orders_status" %}?';
        if (status) url += `status=${encodeURIComponent(status)}&`;
        if (search) url += `search=${encodeURIComponent(search)}&`;

        try {
            const response = await fetch(url);
            const result = await response.json();
            const tbody = document.getElementById('ordersBody');

            if (!result.orders || result.orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">등록된 송장이 없습니다.</td></tr>';
                return;
            }

            tbody.innerHTML = result.orders.map(o => {
                let badgeClass = 'bg-secondary';
                if (o.status === '검수중') badgeClass = 'bg-warning text-dark';
                if (o.status === '완료') badgeClass = 'bg-success';

                const uploaded = new Date(o.uploaded_at).toLocaleDateString('ko-KR');
                const completed = o.completed_at ? new Date(o.completed_at).toLocaleDateString('ko-KR') : '-';

                return `<tr>
                    <td><code>${o.tracking_number}</code></td>
                    <td>${o.seller}</td>
                    <td>${o.receiver_name}</td>
                    <td>${o.product_count}</td>
                    <td><span class="badge badge-status ${badgeClass}">${o.status}</span></td>
                    <td>${uploaded}</td>
                    <td>${completed}</td>
                </tr>`;
            }).join('');
        } catch (error) {
            console.error('목록 로드 실패:', error);
        }
    }

    // 현황 갱신
    async function loadStats() {
        try {
            const response = await fetch('{% url "inspection:get_orders_status" %}');
            const all = await response.json();

            const res1 = await fetch('{% url "inspection:get_orders_status" %}?status=대기중');
            const waiting = await res1.json();
            const res2 = await fetch('{% url "inspection:get_orders_status" %}?status=검수중');
            const inspecting = await res2.json();
            const res3 = await fetch('{% url "inspection:get_orders_status" %}?status=완료');
            const completed = await res3.json();

            document.getElementById('statTotal').textContent = all.total;
            document.getElementById('statWaiting').textContent = waiting.total;
            document.getElementById('statInspecting').textContent = inspecting.total;
            document.getElementById('statCompleted').textContent = completed.total;
        } catch (e) {}
    }

    // 필터/검색
    document.getElementById('statusFilter').addEventListener('change', loadOrders);
    document.getElementById('searchBtn').addEventListener('click', loadOrders);
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadOrders();
    });

    // 초기 로드
    loadOrders();
});
</script>
{% endblock %}
