{% extends 'base.html' %}
{% load static %}

{% block title %}바코드 검수{% endblock %}
{% block page_title %}바코드 검수 시스템{% endblock %}

{% block extra_css %}
<style>
    .scan-input-group {
        position: relative;
    }
    .scan-input-group .form-control {
        font-size: 1.15rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        font-family: 'Noto Sans KR', monospace;
    }
    .scan-input-group .form-control:focus {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }
    .scan-input-group .form-control:disabled {
        background-color: #f0f0f0;
    }

    /* 주문 정보 */
    .order-info {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem 1.25rem;
    }
    .order-info .label {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.15rem;
    }
    .order-info .value {
        font-weight: 500;
        font-size: 0.95rem;
    }

    /* 상품 카드 */
    .product-card {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 0.85rem 1rem;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .product-card.completed {
        border-color: #28a745;
        background: #d4edda;
    }
    .product-card.scanning {
        border-color: #ffc107;
        background: #fff8e1;
    }
    .product-card.error-blink {
        animation: errorBlink 0.4s ease 3;
    }
    @keyframes errorBlink {
        0%, 100% { border-color: #e9ecef; background: #fff; }
        50% { border-color: #dc3545; background: #f8d7da; }
    }

    .product-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 1.1rem;
    }
    .product-icon.waiting {
        background: #e9ecef;
        color: #6c757d;
    }
    .product-icon.scanning {
        background: #fff3cd;
        color: #856404;
        animation: pulse 1s infinite;
    }
    .product-icon.done {
        background: #28a745;
        color: #fff;
    }

    .product-detail {
        flex: 1;
        min-width: 0;
    }
    .product-detail .product-name {
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .product-detail .product-barcode {
        font-size: 0.78rem;
        color: #6c757d;
        font-family: monospace;
    }

    .product-progress {
        flex-shrink: 0;
        text-align: center;
    }
    .product-progress .qty-display {
        font-size: 1.5rem;
        font-weight: 800;
        line-height: 1;
    }
    .product-progress .qty-display.waiting { color: #adb5bd; }
    .product-progress .qty-display.scanning { color: #e67e00; }
    .product-progress .qty-display.done { color: #28a745; }
    .product-progress .qty-label {
        font-size: 0.65rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ===== 풀스크린 오버레이 (공통) ===== */
    .scan-overlay {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: #fff;
        animation: overlayIn 0.15s ease-out;
    }
    .scan-overlay.show {
        display: flex;
    }
    @keyframes overlayIn {
        from { opacity: 0; transform: scale(1.05); }
        to   { opacity: 1; transform: scale(1); }
    }
    .scan-overlay i {
        font-size: 5rem;
        margin-bottom: 0.75rem;
    }
    .scan-overlay .overlay-text {
        font-size: 2.8rem;
        font-weight: 800;
    }
    .scan-overlay .overlay-sub {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-top: 0.4rem;
    }

    /* 완료 - 초록 */
    .scan-overlay.overlay-complete { background: rgba(40, 167, 69, 0.92); }
    /* 정상 - 파랑 */
    .scan-overlay.overlay-ok { background: rgba(13, 110, 253, 0.88); }
    /* 숫자(남은수량) - 파랑 */
    .scan-overlay.overlay-number { background: rgba(13, 110, 253, 0.88); }
    /* 에러 - 빨강 */
    .scan-overlay.overlay-error { background: rgba(220, 53, 69, 0.90); }
    /* 경고 - 주황 */
    .scan-overlay.overlay-warning { background: rgba(255, 152, 0, 0.90); }

    /* 상태 표시 */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.4; }
    }
</style>
{% endblock %}

{% block content %}
<!-- 풀스크린 오버레이 (JS에서 재사용) -->
<div class="scan-overlay" id="scanOverlay">
    <i id="overlayIcon"></i>
    <div class="overlay-text" id="overlayText"></div>
    <div class="overlay-sub" id="overlaySub"></div>
</div>

<div class="row g-3">
    <!-- 스캔 입력 영역 -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-upc-scan me-1"></i>송장번호
                        </label>
                        <div class="scan-input-group">
                            <input type="text" class="form-control" id="trackingNumberInput"
                                   placeholder="송장번호를 스캔하세요" autocomplete="off" autofocus>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-upc me-1"></i>상품바코드
                        </label>
                        <div class="scan-input-group">
                            <input type="text" class="form-control" id="barcodeInput"
                                   placeholder="상품바코드를 스캔하세요" autocomplete="off" disabled>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 상품 목록 (주문정보보다 위로) -->
    <div class="col-12" id="productSection" style="display: none;">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-list-check me-2"></i>상품 목록</h6>
                <span class="badge bg-primary" id="progressBadge">0/0</span>
            </div>
            <div class="card-body">
                <div class="d-flex flex-column gap-2" id="productsContainer"></div>
            </div>
        </div>
    </div>

    <!-- 주문 정보 (상품 목록 아래로) -->
    <div class="col-12" id="orderInfoSection" style="display: none;">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-2">
                <h6 class="mb-0"><i class="bi bi-box-seam me-2"></i>주문 정보</h6>
            </div>
            <div class="card-body py-2">
                <div class="order-info">
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <div class="label">판매처</div>
                            <div class="value" id="infoSeller">-</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="label">수령인</div>
                            <div class="value" id="infoReceiver">-</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="label">연락처</div>
                            <div class="value" id="infoPhone">-</div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="label">상태</div>
                            <div class="value" id="infoStatus">-</div>
                        </div>
                        <div class="col-12">
                            <div class="label">주소</div>
                            <div class="value" id="infoAddress">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const trackingInput = document.getElementById('trackingNumberInput');
    const barcodeInput = document.getElementById('barcodeInput');
    const orderInfoSection = document.getElementById('orderInfoSection');
    const productSection = document.getElementById('productSection');

    // 오버레이 요소
    const scanOverlay = document.getElementById('scanOverlay');
    const overlayIcon = document.getElementById('overlayIcon');
    const overlayText = document.getElementById('overlayText');
    const overlaySub = document.getElementById('overlaySub');

    let currentTrackingNumber = null;
    let currentProducts = [];
    let overlayTimer = null;

    // ===== TTS 음성 =====
    function speak(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.2;
            window.speechSynthesis.speak(utterance);
        }
    }

    const numberWords = ['', '일', '이', '삼', '사', '오', '육', '칠', '팔', '구', '십'];

    function playAlertSound(alertCode, remaining) {
        switch (alertCode) {
            case '정상':    speak('정상'); break;
            case '숫자':
                if (remaining > 0 && remaining <= 10) speak(numberWords[remaining]);
                else if (remaining > 10) speak(String(remaining));
                break;
            case '완료':        speak('검수 완료'); break;
            case '스캔오류':    speak('스캔 오류'); break;
            case '송장번호미등록': speak('송장번호 미등록'); break;
            case '기처리배송':  speak('기처리 배송'); break;
            case '중복스캔':    speak('중복 스캔'); break;
            case '상품오류':    speak('상품 오류'); break;
        }
    }

    // ===== 오버레이 표시 =====
    function showOverlay(type, icon, text, sub, duration) {
        if (overlayTimer) clearTimeout(overlayTimer);

        // 클래스 초기화
        scanOverlay.className = 'scan-overlay show';
        scanOverlay.classList.add('overlay-' + type);
        overlayIcon.className = 'bi ' + icon;
        overlayText.textContent = text;
        overlaySub.textContent = sub || '';

        if (duration > 0) {
            overlayTimer = setTimeout(() => {
                scanOverlay.className = 'scan-overlay';
            }, duration);
        }
    }

    function hideOverlay() {
        if (overlayTimer) clearTimeout(overlayTimer);
        scanOverlay.className = 'scan-overlay';
    }

    // ===== 상품 카드 렌더링 =====
    function renderProducts(products) {
        currentProducts = products;
        const container = document.getElementById('productsContainer');
        let completedCount = 0;
        let totalCount = 0;

        container.innerHTML = products.map(p => {
            const isDone = p.scanned_quantity >= p.quantity;
            const isScanning = p.scanned_quantity > 0 && !isDone;
            if (isDone) completedCount++;
            totalCount++;

            let iconClass, cardClass, qtyClass;
            if (isDone) {
                iconClass = 'done';
                cardClass = 'completed';
                qtyClass = 'done';
            } else if (isScanning) {
                iconClass = 'scanning';
                cardClass = 'scanning';
                qtyClass = 'scanning';
            } else {
                iconClass = 'waiting';
                cardClass = '';
                qtyClass = 'waiting';
            }

            const iconHtml = isDone
                ? '<i class="bi bi-check-lg"></i>'
                : isScanning
                    ? '<i class="bi bi-arrow-repeat"></i>'
                    : '<i class="bi bi-box-seam"></i>';

            return `<div class="product-card ${cardClass}" data-id="${p.id}" data-barcode="${p.barcode}">
                <div class="product-icon ${iconClass}">${iconHtml}</div>
                <div class="product-detail">
                    <div class="product-name">${p.product_name}</div>
                    <div class="product-barcode">${p.barcode}</div>
                </div>
                <div class="product-progress">
                    <div class="qty-display ${qtyClass}">${p.scanned_quantity}/${p.quantity}</div>
                    <div class="qty-label">스캔</div>
                </div>
            </div>`;
        }).join('');

        document.getElementById('progressBadge').textContent = `${completedCount}/${totalCount}`;
    }

    // ===== 초기화 =====
    function resetAll() {
        currentTrackingNumber = null;
        currentProducts = [];
        trackingInput.value = '';
        barcodeInput.value = '';
        barcodeInput.disabled = true;
        orderInfoSection.style.display = 'none';
        productSection.style.display = 'none';
        hideOverlay();
        trackingInput.focus();
    }

    // ===== 송장 조회 =====
    async function fetchOrder(trackingNumber) {
        try {
            const response = await fetch(`{% url "inspection:get_order" tracking_number="__TN__" %}`.replace('__TN__', encodeURIComponent(trackingNumber)));
            const result = await response.json();

            if (result.alert_code === '정상') {
                currentTrackingNumber = trackingNumber;
                playAlertSound('정상');
                showOverlay('ok', 'bi-check-circle-fill', '정상', '상품을 스캔하세요', 800);

                const order = result.order;
                document.getElementById('infoSeller').textContent = order.seller || '-';
                document.getElementById('infoReceiver').textContent = order.receiver_name;
                document.getElementById('infoPhone').textContent = order.receiver_phone;
                document.getElementById('infoAddress').textContent = order.receiver_address;
                document.getElementById('infoStatus').textContent = order.status;
                orderInfoSection.style.display = '';

                renderProducts(result.products);
                productSection.style.display = '';

                barcodeInput.disabled = false;
                barcodeInput.focus();

            } else if (result.alert_code === '송장번호미등록') {
                playAlertSound('송장번호미등록');
                showOverlay('error', 'bi-exclamation-triangle-fill', '송장번호 미등록', '', 1500);
                trackingInput.value = '';
                trackingInput.focus();

            } else if (result.alert_code === '기처리배송') {
                playAlertSound('기처리배송');
                showOverlay('warning', 'bi-exclamation-circle-fill', '기처리 배송', '이미 완료된 송장입니다', 1500);

                const order = result.order;
                document.getElementById('infoSeller').textContent = order.seller || '-';
                document.getElementById('infoReceiver').textContent = order.receiver_name;
                document.getElementById('infoPhone').textContent = order.receiver_phone;
                document.getElementById('infoAddress').textContent = order.receiver_address;
                document.getElementById('infoStatus').textContent = '완료';
                orderInfoSection.style.display = '';

                renderProducts(result.products);
                productSection.style.display = '';

                barcodeInput.disabled = true;
                trackingInput.value = '';
                trackingInput.focus();
            }
        } catch (error) {
            playAlertSound('스캔오류');
            showOverlay('error', 'bi-wifi-off', '네트워크 오류', '', 1500);
            trackingInput.value = '';
            trackingInput.focus();
        }
    }

    // ===== 상품 스캔 =====
    async function scanProduct(trackingNumber, barcode) {
        try {
            const response = await fetch('{% url "inspection:scan_product" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tracking_number: trackingNumber, barcode: barcode }),
            });
            const result = await response.json();

            if (result.success) {
                if (result.alert_code === '완료') {
                    playAlertSound('완료');

                    if (result.product) updateProductInList(result.product);

                    showOverlay('complete', 'bi-check-circle-fill', '검수 완료!', trackingNumber, 0);

                    setTimeout(() => {
                        resetAll();
                    }, 1500);

                } else if (result.alert_code === '숫자') {
                    playAlertSound('숫자', result.remaining);
                    showOverlay('number', 'bi-hash', result.remaining, '남은 수량', 700);

                    if (result.products) renderProducts(result.products);
                    else if (result.product) updateProductInList(result.product);

                    barcodeInput.value = '';
                    barcodeInput.focus();

                } else if (result.alert_code === '정상') {
                    playAlertSound('정상');
                    showOverlay('ok', 'bi-check-circle-fill', '정상', '', 700);

                    if (result.products) renderProducts(result.products);
                    else if (result.product) updateProductInList(result.product);

                    barcodeInput.value = '';
                    barcodeInput.focus();
                }

            } else {
                if (result.alert_code === '상품오류') {
                    playAlertSound('상품오류');
                    showOverlay('error', 'bi-x-circle-fill', '상품 오류', '해당 송장에 없는 상품', 1500);
                } else if (result.alert_code === '중복스캔') {
                    playAlertSound('중복스캔');
                    showOverlay('error', 'bi-arrow-repeat', '중복 스캔', '이미 완료된 상품', 1500);

                    const cards = document.querySelectorAll(`[data-barcode="${barcode}"]`);
                    cards.forEach(card => {
                        card.classList.add('error-blink');
                        setTimeout(() => card.classList.remove('error-blink'), 1200);
                    });
                } else {
                    playAlertSound('스캔오류');
                    showOverlay('error', 'bi-exclamation-triangle-fill', result.message || '스캔 오류', '', 1500);
                }

                barcodeInput.value = '';
                barcodeInput.focus();
            }
        } catch (error) {
            playAlertSound('스캔오류');
            showOverlay('error', 'bi-wifi-off', '네트워크 오류', '', 1500);
            barcodeInput.value = '';
            barcodeInput.focus();
        }
    }

    // 개별 상품 카드 업데이트
    function updateProductInList(product) {
        const card = document.querySelector(`.product-card[data-id="${product.id}"]`);
        if (!card) return;

        const isDone = product.scanned_quantity >= product.quantity;
        const isScanning = product.scanned_quantity > 0 && !isDone;

        // 카드 클래스
        card.className = `product-card ${isDone ? 'completed' : isScanning ? 'scanning' : ''}`;
        card.setAttribute('data-barcode', product.barcode);

        // 아이콘
        const iconEl = card.querySelector('.product-icon');
        if (isDone) {
            iconEl.className = 'product-icon done';
            iconEl.innerHTML = '<i class="bi bi-check-lg"></i>';
        } else if (isScanning) {
            iconEl.className = 'product-icon scanning';
            iconEl.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
        }

        // 수량
        const qtyEl = card.querySelector('.qty-display');
        if (qtyEl) {
            qtyEl.textContent = `${product.scanned_quantity}/${product.quantity}`;
            qtyEl.className = `qty-display ${isDone ? 'done' : isScanning ? 'scanning' : 'waiting'}`;
        }

        // 진행률 뱃지
        updateProgressBadge();
    }

    function updateProgressBadge() {
        const cards = document.querySelectorAll('.product-card');
        let completed = 0;
        cards.forEach(card => {
            if (card.classList.contains('completed')) completed++;
        });
        document.getElementById('progressBadge').textContent = `${completed}/${cards.length}`;
    }

    // ===== 키보드 이벤트 =====
    trackingInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = e.target.value.trim();
            if (value) fetchOrder(value);
        }
    });

    barcodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = e.target.value.trim();
            if (value && currentTrackingNumber) scanProduct(currentTrackingNumber, value);
        }
    });

    // 페이지 로드 시 송장 입력란 포커스
    trackingInput.focus();
});
</script>
{% endblock %}
